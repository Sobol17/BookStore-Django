{% load static %}

{% include 'layout/head-metrics.html' %}

<body class="min-h-screen font-sans text-ink antialiased">
  <div class="min-h-screen bg-paper">
    {% include 'layout/partials/_header.html' %}

    <main id="page" class="mx-auto flex w-full my-container flex-1 flex-col px-4 py-10 sm:px-6 lg:px-8">
      <section class="flex-1" hx-target="this" hx-swap="innerHTML">
        {% if object %}
          {% include 'main/product_detail.html' %}
        {% elif is_catalog_page %}
          <div id="catalog-content" data-name="catalog_page" class="flex flex-col gap-8">
            <header class="flex flex-col gap-4">
              <h1 class="text-4xl font-semibold text-ink">
                {% if current_category %}
                  {{ current_category_label }}
                {% else %}
                  Каталог
                {% endif %}
              </h1>
            </header>
            
            {% if all_genres %}
              {% include 'main/partials/_all_genres.html' with all_genres=all_genres %}
            {% endif %}

            <div class="grid gap-6 lg:grid-cols-[minmax(0,275px)_1fr]">
              {% include 'main/partials/_catalog_filters.html' %}

              <div class="space-y-8">
                {% if search_query %}
                  <p class="text-sm text-ink-muted">
                    Найдено по запросу
                    <span class="font-semibold text-accent">«{{ search_query }}»</span>
                  </p>
                {% endif %}
                
                <div class="relative">
                {% include 'main/partials/_catalog_sort.html' %}
                  {% if genre_filters and current_category %}
                      <div class="mb-3 flex flex-wrap gap-2">
                        <button
                          type="button"
                          class="rounded-xl border border-accent px-4 py-2 text-sm font-semibold transition hover:bg-accent-soft {% if not active_genres %}bg-accent text-graphite{% else %}bg-white text-ink{% endif %}"
                          hx-get="{{ genre_reset_url }}"
                          hx-target="#catalog-content"
                          hx-swap="outerHTML"
                          hx-push-url="true"
                          hx-indicator="#catalog-loading"
                        >
                          <span class="flex items-center gap-2">
                            {% if not active_genres %}
                              <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-white/90 text-xs font-bold text-graphite">✓</span>
                            {% endif %}
                            <span>Все жанры</span>
                          </span>
                        </button>
                        {% for genre in genre_filters %}
                          <button
                            type="button"
                            class="rounded-xl border border-accent px-4 py-2 text-sm font-semibold transition hover:bg-accent-soft {% if genre.is_active %}bg-accent text-graphite{% else %}bg-white text-ink{% endif %}"
                            hx-get="{{ genre.url }}"
                            hx-target="#catalog-content"
                            hx-swap="outerHTML"
                            hx-push-url="true"
                            hx-indicator="#catalog-loading"
                          >
                            <span class="flex items-center gap-2">
                              {% if genre.is_active %}
                                <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-white/90 text-xs font-bold text-graphite">✓</span>
                              {% endif %}
                              <span>{{ genre.label }}</span>
                            </span>
                          </button>
                        {% endfor %}
                      </div>
                    {% elif categories %}
                      <div class="mb-3 flex flex-wrap gap-2">
                        {% for category in categories %}
                          <a
                            href="{% url 'main:catalog' category.slug %}"
                            hx-get="{% url 'main:catalog' category.slug %}"
                            hx-target="#catalog-content"
                            hx-swap="outerHTML"
                            hx-push-url="true"
                            hx-indicator="#catalog-loading"
                            class="rounded-xl border border-accent px-4 py-2 text-sm font-semibold transition hover:bg-accent-soft {% if current_category == category.slug %}bg-accent text-graphite{% else %}bg-white text-ink{% endif %}"
                          >
                            {{ category.name }}
                          </a>
                        {% endfor %}
                      </div>
                    {% endif %}
                  <div class="grid gap-6 grid-cols-2 sm:grid-cols-3 xl:grid-cols-4">
                    {% for product in products %}
                      {% include 'main/partials/_product-card.html' with product=product %}
                    {% empty %}
                      <div class="col-span-full rounded-3xl border border-accent-soft/60 bg-white p-12 text-center text-ink-muted">
                        К сожалению, по выбранным параметрам ничего не найдено. Попробуйте изменить условия поиска.
                      </div>
                    {% endfor %}
                  </div>
                  {% if is_paginated and pagination.links %}
                    <nav class="mt-6 flex flex-wrap items-center justify-center gap-2 text-sm" aria-label="Пагинация каталога">
                      {% if pagination.has_previous %}
                        <button
                          type="button"
                          class="rounded-lg border border-accent px-3 py-1 font-semibold text-ink transition hover:bg-accent-soft"
                          hx-get="{{ pagination.previous_url }}"
                          hx-target="#catalog-content"
                          hx-swap="outerHTML"
                          hx-push-url="true"
                          hx-indicator="#catalog-loading"
                        >
                          Назад
                        </button>
                      {% endif %}
                      {% for link in pagination.links %}
                        {% if link.is_gap %}
                          <span class="px-2 text-ink-muted">…</span>
                        {% else %}
                          <button
                            type="button"
                            class="rounded-lg border border-accent px-3 py-1 font-semibold transition hover:bg-accent-soft {% if link.is_current %}bg-accent text-graphite{% else %}bg-white text-ink{% endif %}"
                            hx-get="{{ link.url }}"
                            hx-target="#catalog-content"
                            hx-swap="outerHTML"
                            hx-push-url="true"
                            hx-indicator="#catalog-loading"
                            aria-current="{% if link.is_current %}page{% else %}false{% endif %}"
                          >
                            {{ link.label }}
                          </button>
                        {% endif %}
                      {% endfor %}
                      {% if pagination.has_next %}
                        <button
                          type="button"
                          class="rounded-lg border border-accent px-3 py-1 font-semibold text-ink transition hover:bg-accent-soft"
                          hx-get="{{ pagination.next_url }}"
                          hx-target="#catalog-content"
                          hx-swap="outerHTML"
                          hx-push-url="true"
                          hx-indicator="#catalog-loading"
                        >
                          Вперёд
                        </button>
                      {% endif %}
                    </nav>
                  {% endif %}
                  <div
                    id="catalog-loading"
                    class="htmx-indicator absolute inset-0 z-20 flex items-center justify-center bg-paper/70 backdrop-blur-sm"
                    style="display: none;"
                    role="status"
                    aria-live="polite"
                    aria-atomic="true"
                  >
                    <div class="flex flex-col items-center gap-3 text-ink-muted">
                      <svg
                        class="h-10 w-10 animate-spin text-accent"
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                      >
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 0113.657-5.657l-2.829 2.829A4 4 0 008 12H4z"></path>
                      </svg>
                      <span class="text-sm">Ищем книги…</span>
                      <span class="sr-only">Идёт загрузка каталога</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% else %}
          <div data-name="home_page" class="space-y-16">
            {% include 'main/partials/_banner.html' with banners=banners %}

            {% if categories %}
              <section>
                <h2 class="text-2xl font-bold">Подборки</h2>
                
                <div class="mt-8 grid gap-6 sm:grid-cols-2 xl:grid-cols-3">
                  {% for category in categories %}
                    <a
                      href="{% url 'main:catalog' category.slug %}"
                      class="relative flex flex-col gap-1 overflow-hidden rounded-xl border border-accent-soft/60 bg-white p-6 transition hover:shadow-xl"
                    >
                      {% if category.image %}
                        <img
                          src="{{ category.image.url }}"
                          alt="{{ category.name }}"
                          class="w-full h-auto object-cover rounded-xl"
                        >
                      {% else %}
                        <div
                          class="w-full h-44 rounded-xl bg-accent-soft/40 border border-accent-soft/60"
                          aria-hidden="true"
                        ></div>
                      {% endif %}
                      <h3 class="text-2xl font-bold text-ink text-center mt-1">{{ category }}</h3>
                    </a>
                  {% endfor %}
                </div>
              </section>
            {% endif %}

            {% comment %} <section class="relative overflow-hidden rounded-2xl border border-accent-soft/50 bg-white p-7 lg:p-10">
              <div class="absolute inset-0"></div>
              <div class="relative grid gap-7 lg:grid-cols-[minmax(0,1.1fr)_minmax(0,0.9fr)]">
                <div class="space-y-6">
                  <p class="text-xs text-accent-darker">
                    Букинистический салон старинных книг и атрибутики
                  </p>
                  <h1 class="font-serif text-4xl leading-tight text-ink sm:text-5xl">
                    Атмосфера старой библиотеки <span class="text-accent-darker">в вашем экране</span>
                  </h1>
                  <p class="text-lg text-ink-muted">
                    Libra Antiqua — коллекция отобранных изданий, сохранивших тепло страниц и историю владельцев. Мы подбираем редкие книги, которые хочется держать в руках.
                  </p>
                  <div class="flex flex-wrap gap-4">
                    <a
                      href="{% url 'main:catalog_all' %}"
                      class="rounded-xl border border-accent-soft bg-accent px-6 py-3 text-sm font-semibold text-ink transition hover:bg-accent-dark hover:text-graphite"
                    >
                      Перейти в каталог
                    </a>
                    <a
                      href="#about"
                      class="rounded-xl border border-accent-darker px-6 py-3 text-sm font-semibold text-accent-darker transition hover:border-ink hover:bg-accent-soft/20 hover:text-ink"
                    >
                      О коллекции
                    </a>
                  </div>
                </div>
                <div class="relative">
                  <div class="absolute inset-0 translate-x-6 translate-y-6 rounded-3xl border border-accent-soft/70"></div>
                </div>
              </div>
            </section> {% endcomment %}

            {% include 'main/partials/_product-slider.html' with products=new_products title="Новинки" link=new_products_link %}

            <section id="about" class="grid gap-6 rounded-3xl border border-accent-soft/60 bg-white p-8 lg:grid-cols-[2fr_1fr] lg:items-center">
              <div class="space-y-4">
                <h2 class="text-3xl text-ink">Мы можем купить книги у вас</h2>
                <p class="text-base text-ink-muted">
                  Покупаем редкие и коллекционные издания у частных владельцев и библиотек.
                </p>
                <ul class="space-y-3 text-sm text-ink">
                  <li class="flex items-start gap-3">
                    <span class="mt-1 h-2 w-2 rounded-full bg-graphite shrink-0"></span>
                    Быстрая предварительная оценка по описанию и фото.
                  </li>
                  <li class="flex items-start gap-3">
                    <span class="mt-1 h-2 w-2 rounded-full bg-graphite shrink-0"></span>
                    Гибкие форматы сделки: лично, курьером или по почте.
                  </li>
                  <li class="flex items-start gap-3">
                    <span class="mt-1 h-2 w-2 rounded-full bg-graphite shrink-0"></span>
                    Безопасные расчёты и бережная логистика.
                  </li>
                </ul>
                <div class="flex flex-wrap gap-3">
                  <a href="{% url 'main:book_purchase' %}" class="inline-flex items-center gap-2 rounded-xl bg-accent px-5 py-3 text-sm font-semibold text-graphite transition hover:bg-accent-dark">
                    <i data-lucide="send" class="h-4 w-4"></i>
                    <span>Оставить заявку</span>
                  </a>
                  <a href="https://t.me/dombb" class="inline-flex items-center gap-2 rounded-xl border border-accent-soft px-5 py-3 text-sm font-semibold text-ink transition hover:border-accent hover:bg-accent-soft">
                    <i data-lucide="message-circle" class="h-4 w-4"></i>
                    <span>Связаться</span>
                  </a>
                </div>
              </div>
              <div class="rounded-2xl border border-dashed border-accent-soft bg-accent-soft/40 p-6 text-sm text-ink-muted">
                <p class="mt-2 font-semibold text-ink">Ответим в течение 1-2 рабочих дней.</p>
                <p class="mt-2">Для срочной связи используйте Telegram или WhatsApp.</p>
              </div>
            </section>
          </div>
        {% endif %}
      </section>
    </main>

    <section id="modal-root" class="mx-auto w-full my-container px-4 sm:px-6 lg:px-8" hx-target="this" hx-swap="innerHTML"></section>

    <div id="cart-container"></div>

    {% include 'layout/partials/_footer.html' %}
  </div>

  {% include 'layout/footer-scripts.html' %}
</body>
</html>
