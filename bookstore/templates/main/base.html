{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>
    Dombb —
    {% if object %}
      {{ object.name }}
    {% elif is_catalog_page %}
      Каталог редких книг
    {% else %}
      Атмосфера букинистики
    {% endif %}
  </title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Playfair+Display:wght@400;500;600;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css">
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            paper: '#f1f1f1',
            ink: '#1F2532',
            'ink-muted': '#6F7588',
            accent: '#8BE3F5',
            'accent-dark': '#6FCBE0',
            'accent-darker': '#47A9C3',
            'accent-soft': '#E6F8FC',
            coffee: '#101829',
            blush: '#F26D9F',
            mint: '#C6F68D',
            graphite: '#2A3548'
          },
          fontFamily: {
            sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'],
            serif: ['Playfair Display', 'ui-serif', 'Georgia', 'serif']
          },
          boxShadow: {
            lamplight: '0 25px 50px -12px rgba(34, 49, 84, 0.22)',
            header: '0 18px 45px rgba(26, 37, 64, 0.08)',
            card: '0 22px 35px -18px rgba(29, 38, 59, 0.2)'
          }
        }
      }
    }
  </script>
  <style>
    [x-cloak] {
      display: none !important;
    }
    body {
      background-color: #F1F4FA;
      color: #1F2532;
      background-image: none;
    }
    .my-container {
      max-width: 1280px;
    }
    .input {
      background-color: #5d889614;
      border: 1px solid transparent;
      font-size: 0.875rem;
      line-height: 1.25rem;
      padding-left: 1rem;
      padding-right: 1rem;
      border-radius: 0.5rem;
      padding-top: 0.5rem;
      padding-bottom: 0.5rem;
      width: 100%;
    }
    input:focus {
      outline: none;
      border-color: #8BE3F5;
    }
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
        /* display: none; <- Crashes Chrome on hover */
        -webkit-appearance: none;
        margin: 0; /* <-- Apparently some margin are still there even though it's hidden */
    }
    input[type=number] {
        -moz-appearance:textfield; /* Firefox */
    }
    .input:focus {
        background-color: #fff;
        border-color: #f1f1f1;
    }
  </style>
  {% block head_extra %}{% endblock %}
</head>
<body class="min-h-screen font-sans text-ink antialiased">
  <div class="min-h-screen bg-paper">
    {% include 'main/partials/_header.html' %}

    <main id="page" class="mx-auto flex w-full my-container flex-1 flex-col px-4 py-10 sm:px-6 lg:px-8">
      <section class="flex-1" hx-target="this" hx-swap="innerHTML">
        {% if object %}
          {% include 'main/product_detail.html' %}
        {% elif is_catalog_page %}
          <div id="catalog-content" data-name="catalog_page" class="flex flex-col gap-8">
            <header class="flex flex-col gap-4">
              <h1 class="text-4xl font-semibold text-ink">
                {% if current_category %}
                  {{ current_category_label }}
                {% else %}
                  Каталог
                {% endif %}
              </h1>
            </header>

            <div class="grid gap-6 lg:grid-cols-[minmax(0,275px)_1fr]">
              {% include 'main/partials/_catalog_filters.html' %}

              <div class="space-y-8">
                {% if search_query %}
                  <p class="text-sm text-ink-muted">
                    Найдено по запросу
                    <span class="font-semibold text-accent">«{{ search_query }}»</span>
                  </p>
                {% endif %}
                
                <div class="relative">
                {% include 'main/partials/_catalog_sort.html' %}
                  {% if genre_filters and current_category %}
                      <div class="mb-3 flex flex-wrap gap-2">
                        <button
                          type="button"
                          class="rounded-xl border border-accent px-4 py-2 text-sm font-semibold transition hover:bg-accent-soft {% if not active_genre %}bg-accent text-graphite{% else %}bg-white text-ink{% endif %}"
                          hx-get="{{ genre_reset_url }}"
                          hx-target="#catalog-content"
                          hx-swap="outerHTML"
                          hx-push-url="true"
                          hx-indicator="#catalog-loading"
                        >
                          Все жанры
                        </button>
                        {% for genre in genre_filters %}
                          <button
                            type="button"
                            class="rounded-xl border border-accent px-4 py-2 text-sm font-semibold transition hover:bg-accent-soft {% if genre.is_active %}bg-accent text-graphite{% else %}bg-white text-ink{% endif %}"
                            hx-get="{{ genre.url }}"
                            hx-target="#catalog-content"
                            hx-swap="outerHTML"
                            hx-push-url="true"
                            hx-indicator="#catalog-loading"
                          >
                            {{ genre.label }}
                          </button>
                        {% endfor %}
                      </div>
                    {% elif categories %}
                      <div class="mb-3 flex flex-wrap gap-2">
                        {% for category in categories %}
                          <a
                            href="{% url 'main:catalog' category.slug %}"
                            hx-get="{% url 'main:catalog' category.slug %}"
                            hx-target="#catalog-content"
                            hx-swap="outerHTML"
                            hx-push-url="true"
                            hx-indicator="#catalog-loading"
                            class="rounded-xl border border-accent px-4 py-2 text-sm font-semibold transition hover:bg-accent-soft {% if current_category == category.slug %}bg-accent text-graphite{% else %}bg-white text-ink{% endif %}"
                          >
                            {{ category.name }}
                          </a>
                        {% endfor %}
                      </div>
                    {% endif %}
                  <div class="grid gap-6 sm:grid-cols-4">
                    {% for product in products %}
                      {% include 'main/partials/_product-card.html' with product=product %}
                    {% empty %}
                      <div class="col-span-full rounded-3xl border border-accent-soft/60 bg-white p-12 text-center text-ink-muted">
                        К сожалению, по выбранным параметрам ничего не найдено. Попробуйте изменить условия поиска.
                      </div>
                    {% endfor %}
                  </div>
                  {% if is_paginated and pagination.links %}
                    <nav class="mt-6 flex flex-wrap items-center justify-center gap-2 text-sm" aria-label="Пагинация каталога">
                      {% if pagination.has_previous %}
                        <button
                          type="button"
                          class="rounded-lg border border-accent px-3 py-1 font-semibold text-ink transition hover:bg-accent-soft"
                          hx-get="{{ pagination.previous_url }}"
                          hx-target="#catalog-content"
                          hx-swap="outerHTML"
                          hx-push-url="true"
                          hx-indicator="#catalog-loading"
                        >
                          Назад
                        </button>
                      {% endif %}
                      {% for link in pagination.links %}
                        {% if link.is_gap %}
                          <span class="px-2 text-ink-muted">…</span>
                        {% else %}
                          <button
                            type="button"
                            class="rounded-lg border border-accent px-3 py-1 font-semibold transition hover:bg-accent-soft {% if link.is_current %}bg-accent text-graphite{% else %}bg-white text-ink{% endif %}"
                            hx-get="{{ link.url }}"
                            hx-target="#catalog-content"
                            hx-swap="outerHTML"
                            hx-push-url="true"
                            hx-indicator="#catalog-loading"
                            aria-current="{% if link.is_current %}page{% else %}false{% endif %}"
                          >
                            {{ link.label }}
                          </button>
                        {% endif %}
                      {% endfor %}
                      {% if pagination.has_next %}
                        <button
                          type="button"
                          class="rounded-lg border border-accent px-3 py-1 font-semibold text-ink transition hover:bg-accent-soft"
                          hx-get="{{ pagination.next_url }}"
                          hx-target="#catalog-content"
                          hx-swap="outerHTML"
                          hx-push-url="true"
                          hx-indicator="#catalog-loading"
                        >
                          Вперёд
                        </button>
                      {% endif %}
                    </nav>
                  {% endif %}
                  <div
                    id="catalog-loading"
                    class="htmx-indicator absolute inset-0 z-20 flex items-center justify-center bg-paper/70 backdrop-blur-sm"
                    style="display: none;"
                    role="status"
                    aria-live="polite"
                    aria-atomic="true"
                  >
                    <div class="flex flex-col items-center gap-3 text-ink-muted">
                      <svg
                        class="h-10 w-10 animate-spin text-accent"
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                      >
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 0113.657-5.657l-2.829 2.829A4 4 0 008 12H4z"></path>
                      </svg>
                      <span class="text-sm">Ищем книги…</span>
                      <span class="sr-only">Идёт загрузка каталога</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% else %}
          <div data-name="home_page" class="space-y-16">
            {% include 'main/partials/_banner.html' with banners=banners %}

            <section class="relative overflow-hidden rounded-2xl border border-accent-soft/50 bg-white p-7 lg:p-10">
              <div class="absolute inset-0"></div>
              <div class="relative grid gap-7 lg:grid-cols-[minmax(0,1.1fr)_minmax(0,0.9fr)]">
                <div class="space-y-6">
                  <p class="text-xs text-accent-darker">
                    Букинистический салон старинных книг и атрибутики
                  </p>
                  <h1 class="font-serif text-4xl leading-tight text-ink sm:text-5xl">
                    Атмосфера старой библиотеки <span class="text-accent-darker">в вашем экране</span>
                  </h1>
                  <p class="text-lg text-ink-muted">
                    Libra Antiqua — коллекция отобранных изданий, сохранивших тепло страниц и историю владельцев. Мы подбираем редкие книги, которые хочется держать в руках.
                  </p>
                  <div class="flex flex-wrap gap-4">
                    <a
                      href="{% url 'main:catalog_all' %}"
                      class="rounded-xl border border-accent-soft bg-accent px-6 py-3 text-sm font-semibold text-ink transition hover:bg-accent-dark hover:text-graphite"
                    >
                      Перейти в каталог
                    </a>
                    <a
                      href="#about"
                      class="rounded-xl border border-accent-darker px-6 py-3 text-sm font-semibold text-accent-darker transition hover:border-ink hover:bg-accent-soft/20 hover:text-ink"
                    >
                      О коллекции
                    </a>
                  </div>
                </div>
                <div class="relative">
                  <div class="absolute inset-0 translate-x-6 translate-y-6 rounded-3xl border border-accent-soft/70"></div>
                  <img
                    src="{% static 'images/demo-cover-1.jpg' %}"
                    alt="Интерьер букинистического магазина"
                    class="relative h-full w-full rounded-3xl object-cover"
                  >
                </div>
              </div>
            </section>

            {% include 'main/partials/_product-slider.html' with products=new_products title="Новинки" link=new_products_link %}

            {% if categories %}
              <section>
                <h2 class="text-2xl font-bold">Коллекции и жанры</h2>
                
                <div class="mt-8 grid gap-6 sm:grid-cols-2 xl:grid-cols-3">
                  {% for category in categories %}
                    <a
                      href="{% url 'main:catalog' category.slug %}"
                      class="relative flex flex-col gap-1 overflow-hidden rounded-xl border border-accent-soft/60 bg-white p-6 transition hover:shadow-xl"
                    >
                      <span class="text-sm text-bold text-graphite">Коллекция</span>
                      <h3 class="text-2xl font-bold text-ink">{{ category.name }}</h3>
                      <p class="text-sm text-ink-muted">
                        {% if category.meta_description %}
                          {{ category.meta_description }}
                        {% else %}
                          Подборка изданий, созданных для ценителей редких книг и уникальных находок.
                        {% endif %}
                      </p>
                      <span class="mt-4 text-sm font-bold text-accent-darker">
                        Смотреть книги →
                      </span>
                      <div class="absolute inset-0 rounded-3xl border border-transparent transition group-hover:border-accent"></div>
                    </a>
                  {% endfor %}
                </div>
              </section>
            {% endif %}

            {% include 'main/partials/_product-slider.html' with products=new_products title="Рекомендуемые находки" link=new_products_link %}

            <section id="about" class="grid gap-10 rounded-3xl border border-accent-soft/60 bg-white p-10 lg:grid-cols-2">
              <div class="space-y-4">
                <h2 class="font-serif text-3xl text-ink">Традиции букинистики и современные технологии</h2>
                <p class="text-base text-ink-muted">
                  Мы бережно описываем каждое издание, фиксируем состояние переплётов и листов, подбираем обложки с характером и историей. Коллекция регулярно пополняется благодаря партнёрам и частным библиотекам.
                </p>
                <ul class="space-y-3 text-sm text-ink">
                  <li class="flex items-start gap-3">
                    <span class="mt-1 h-2 w-2 rounded-full bg-graphite shrink-0"></span>
                    Гарантируем подлинность происхождения и описанного состояния каждого экземпляра.
                  </li>
                  <li class="flex items-start gap-3">
                    <span class="mt-1 h-2 w-2 rounded-full bg-graphite shrink-0"></span>
                    Помогаем подобрать книги под интерьер, коллекцию или конкретного адресата.
                  </li>
                  
                </ul>
              </div>
              <div class="space-y-4 rounded-2xl border border-accent-soft/60 bg-white p-7">
                <h3 class="font-serif text-xl">Экспресс-консультация</h3>
                <p class="text-sm text-ink-muted">
                  Не нашли нужную книгу? Оставьте запрос — мы проверим архивные фонды и партнёрские каталоги.
                </p>
                <form class="space-y-4">
                    <div>
                    <label for="request-phone" class="text-sm text-ink-muted mb-1">Телефон</label>
                    <input
                      id="request-phone"
                      type="text"
                      placeholder="Введите телефон"
                      class="input h-10 w-full rounded-xl px-6 text-sm text-ink placeholder:text-ink-muted/70 focus:outline-none md:h-12"
                    >
                  </div>
                  <div>
                    <label for="request-name" class="text-sm text-ink-muted mb-1">Имя</label>
                    <input
                      id="request-name"
                      type="text"
                      placeholder="Введите имя"
                      class="input h-10 w-full rounded-xl px-6 text-sm text-ink placeholder:text-ink-muted/70 focus:outline-none md:h-12"
                    >
                  </div>
                  <div>
                    <label for="request-book" class="text-sm text-ink-muted mb-1">Запрос</label>
                    <textarea
                      id="request-book"
                      rows="3"
                      placeholder="Автор, название или описание нужной книги"
                      class="input mt-2 w-full rounded-xl px-4 py-2 text-sm text-ink placeholder:text-ink-muted/70 resize-none focus:outline-none"
                    ></textarea>
                  </div>
                  <button
                    type="submit"
                    class="w-full rounded-xl border border-accent-soft bg-accent px-5 py-3 text-sm font-semibold text-ink transition hover:bg-accent-dark hover:text-graphite"
                  >
                    Отправить
                  </button>
                </form>
              </div>
            </section>
          </div>
        {% endif %}
      </section>
    </main>

    <section id="modal-root" class="mx-auto w-full my-container px-4 sm:px-6 lg:px-8" hx-target="this" hx-swap="innerHTML"></section>

    {% include 'main/partials/_footer.html' %}
  </div>

  <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.7/dist/htmx.min.js" integrity="sha384-ZBXiYtYQ6hJ2Y0ZNoYuI+Nq5MqWBr+chMrS/RkXpNzQCApHEhOt2aY8EJgqwHLkJ" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js" defer></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
	  lucide.createIcons();
	
    document.body.addEventListener('htmx:configRequest', function (event) {
      const csrf = document.querySelector('input[name="csrfmiddlewaretoken"]');
      if (csrf) {
        event.detail.headers['X-CSRFToken'] = csrf.value;
      }
    });
    function initProductSliders() {
      if (!window.Swiper) {
        return;
      }
      document.querySelectorAll('[data-banner-id]').forEach(function (bannerRoot) {
        const mainSlider = bannerRoot.querySelector('.js-banner-slider');
        if (!mainSlider || mainSlider.dataset.sliderInitialized === 'true') {
          return;
        }
        const thumbsEl = bannerRoot.querySelector('.js-banner-thumbs');
        let thumbsSwiper = null;
        if (thumbsEl && thumbsEl.dataset.sliderInitialized !== 'true') {
          thumbsSwiper = new Swiper(thumbsEl, {
            slidesPerView: 4,
            spaceBetween: 12,
            freeMode: true,
            watchSlidesProgress: true,
            breakpoints: {
              1280: { slidesPerView: 7 },
            }
          });
          thumbsEl.dataset.sliderInitialized = 'true';
        }
        const bannerOptions = {
          slidesPerView: 1,
          loop: true,
          autoplay: {
            delay: 4800,
            disableOnInteraction: false
          },
          speed: 1400,
          spaceBetween: 30
        };
        if (thumbsSwiper) {
          bannerOptions.thumbs = { swiper: thumbsSwiper };
        }
        const prev = bannerRoot.querySelector('.js-banner-prev');
        const next = bannerRoot.querySelector('.js-banner-next');
        if (prev && next) {
          bannerOptions.navigation = {
            prevEl: prev,
            nextEl: next
          };
        }
        new Swiper(mainSlider, bannerOptions);
        mainSlider.dataset.sliderInitialized = 'true';
      });
      document.querySelectorAll('.js-product-slider').forEach(function (container) {
        if (container.dataset.sliderInitialized === 'true') {
          return;
        }
        const root = container.closest('[data-slider-root]');
        const options = {
          slidesPerView: 1.9,
          spaceBetween: 8,
          breakpoints: {
            420: { slidesPerView: 2.2, spaceBetween: 8 },
            640: { slidesPerView: 3, spaceBetween: 20 },
            1024: { slidesPerView: 4, spaceBetween: 24 },
            1280: { slidesPerView: 5, spaceBetween: 28 }
          }
        };
        if (root) {
          const prev = root.querySelector('.js-slider-prev');
          const next = root.querySelector('.js-slider-next');
          if (prev && next) {
            options.navigation = {
              prevEl: prev,
              nextEl: next
            };
          }
        }
        new Swiper(container, options);
        container.dataset.sliderInitialized = 'true';
        
      });
    }

    function initProductGallery() {
      if (!window.Swiper) {
        return;
      }
      document.querySelectorAll('[data-gallery-root]').forEach(function (root) {
        const gallery = root.querySelector('.js-product-gallery');
        if (!gallery || gallery.dataset.sliderInitialized === 'true') {
          return;
        }
        const slidesCount = gallery.querySelectorAll('.swiper-slide').length;
        const prev = root.querySelector('.js-gallery-prev');
        const next = root.querySelector('.js-gallery-next');
        const thumbsEl = root.querySelector('.js-product-gallery-thumbs');
        let thumbsSwiper = null;
        if (thumbsEl && slidesCount > 1) {
          thumbsSwiper = new Swiper(thumbsEl, {
            slidesPerView: 3.2,
            spaceBetween: 12,
            freeMode: true,
            watchSlidesProgress: true,
            breakpoints: {
              640: { slidesPerView: 4 },
              1024: { slidesPerView: 5 },
            }
          });
          thumbsEl.dataset.sliderInitialized = 'true';
        }
        const options = {
          slidesPerView: 1,
          spaceBetween: 12,
          loop: slidesCount > 1,
          speed: 600,
        };
        if (thumbsSwiper) {
          options.thumbs = { swiper: thumbsSwiper };
        }
        if (prev && next && slidesCount > 1) {
          options.navigation = {
            prevEl: prev,
            nextEl: next,
          };
          prev.classList.remove('hidden');
          next.classList.remove('hidden');
        }
        new Swiper(gallery, options);
        gallery.dataset.sliderInitialized = 'true';
      });
    }

    document.addEventListener('DOMContentLoaded', function () {
      initProductSliders();
      initProductGallery();
    });
    document.body.addEventListener('htmx:afterSwap', function (event) {
      lucide.createIcons();
      
      if (event.detail.target && event.detail.target.closest('#page')) {
        initProductSliders();
        initProductGallery();
        lucide.createIcons();
      }
    });
  </script>
  {% block body_scripts %}{% endblock %}
</body>
</html>
