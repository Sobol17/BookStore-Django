{% load static %}

{% include 'layout/head-metrics.html' %}

<body class="min-h-screen font-sans text-ink antialiased">
  <div class="min-h-screen bg-paper">
    {% include 'layout/partials/_header.html' %}

    <main id="page" class="mx-auto flex w-full my-container flex-1 flex-col px-4 py-10 sm:px-6 lg:px-8">
      <section class="flex-1" hx-target="this" hx-swap="innerHTML">
        {% if object %}
          {% include 'main/product_detail.html' %}
        {% elif is_catalog_page %}
          <div id="catalog-content" data-name="catalog_page" class="flex flex-col gap-8">
            <header class="flex flex-col gap-4">
              <h1 class="text-4xl font-semibold text-ink">
                {% if current_category %}
                  {{ current_category_label }}
                {% else %}
                  Каталог
                {% endif %}
              </h1>
            </header>
            
            {% if all_genres %}
              {% include 'main/partials/_all_genres.html' with all_genres=all_genres %}
            {% endif %}

            <div class="grid gap-6 lg:grid-cols-[minmax(0,275px)_1fr]">
              {% include 'main/partials/_catalog_filters.html' %}

              <div class="space-y-8">
                {% if search_query %}
                  <p class="text-sm text-ink-muted">
                    Найдено по запросу
                    <span class="font-semibold text-accent">«{{ search_query }}»</span>
                  </p>
                {% endif %}
                
                <div class="relative">
                {% include 'main/partials/_catalog_sort.html' %}
                  {% if genre_filters and current_category %}
                      <div class="mb-3 flex flex-wrap gap-2">
                        <button
                          type="button"
                          class="rounded-xl border border-accent px-4 py-2 text-sm font-semibold transition hover:bg-accent-soft {% if not active_genres %}bg-accent text-graphite{% else %}bg-white text-ink{% endif %}"
                          hx-get="{{ genre_reset_url }}"
                          hx-target="#catalog-content"
                          hx-swap="outerHTML"
                          hx-push-url="true"
                          hx-indicator="#catalog-loading"
                        >
                          <span class="flex items-center gap-2">
                            {% if not active_genres %}
                              <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-white/90 text-xs font-bold text-graphite">✓</span>
                            {% endif %}
                            <span>Все жанры</span>
                          </span>
                        </button>
                        {% for genre in genre_filters %}
                          <button
                            type="button"
                            class="rounded-xl border border-accent px-4 py-2 text-sm font-semibold transition hover:bg-accent-soft {% if genre.is_active %}bg-accent text-graphite{% else %}bg-white text-ink{% endif %}"
                            hx-get="{{ genre.url }}"
                            hx-target="#catalog-content"
                            hx-swap="outerHTML"
                            hx-push-url="true"
                            hx-indicator="#catalog-loading"
                          >
                            <span class="flex items-center gap-2">
                              {% if genre.is_active %}
                                <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-white/90 text-xs font-bold text-graphite">✓</span>
                              {% endif %}
                              <span>{{ genre.label }}</span>
                            </span>
                          </button>
                        {% endfor %}
                      </div>
                    {% elif categories %}
                      <div class="mb-3 flex flex-wrap gap-2">
                        {% for category in categories %}
                          <a
                            href="{% url 'main:catalog' category.slug %}"
                            hx-get="{% url 'main:catalog' category.slug %}"
                            hx-target="#catalog-content"
                            hx-swap="outerHTML"
                            hx-push-url="true"
                            hx-indicator="#catalog-loading"
                            class="rounded-xl border border-accent px-4 py-2 text-sm font-semibold transition hover:bg-accent-soft {% if current_category == category.slug %}bg-accent text-graphite{% else %}bg-white text-ink{% endif %}"
                          >
                            {{ category.name }}
                          </a>
                        {% endfor %}
                      </div>
                    {% endif %}
                  <div class="grid gap-6 grid-cols-2 sm:grid-cols-3 xl:grid-cols-4">
                    {% for product in products %}
                      {% include 'main/partials/_product-card.html' with product=product %}
                    {% empty %}
                      <div class="col-span-full rounded-3xl border border-accent-soft/60 bg-white p-12 text-center text-ink-muted">
                        К сожалению, по выбранным параметрам ничего не найдено. Попробуйте изменить условия поиска.
                      </div>
                    {% endfor %}
                  </div>
                  {% if is_paginated and pagination.links %}
                    <nav class="mt-6 flex flex-wrap items-center justify-center gap-2 text-sm" aria-label="Пагинация каталога">
                      {% if pagination.has_previous %}
                        <button
                          type="button"
                          class="rounded-lg border border-accent px-3 py-1 font-semibold text-ink transition hover:bg-accent-soft"
                          hx-get="{{ pagination.previous_url }}"
                          hx-target="#catalog-content"
                          hx-swap="outerHTML"
                          hx-push-url="true"
                          hx-indicator="#catalog-loading"
                        >
                          Назад
                        </button>
                      {% endif %}
                      {% for link in pagination.links %}
                        {% if link.is_gap %}
                          <span class="px-2 text-ink-muted">…</span>
                        {% else %}
                          <button
                            type="button"
                            class="rounded-lg border border-accent px-3 py-1 font-semibold transition hover:bg-accent-soft {% if link.is_current %}bg-accent text-graphite{% else %}bg-white text-ink{% endif %}"
                            hx-get="{{ link.url }}"
                            hx-target="#catalog-content"
                            hx-swap="outerHTML"
                            hx-push-url="true"
                            hx-indicator="#catalog-loading"
                            aria-current="{% if link.is_current %}page{% else %}false{% endif %}"
                          >
                            {{ link.label }}
                          </button>
                        {% endif %}
                      {% endfor %}
                      {% if pagination.has_next %}
                        <button
                          type="button"
                          class="rounded-lg border border-accent px-3 py-1 font-semibold text-ink transition hover:bg-accent-soft"
                          hx-get="{{ pagination.next_url }}"
                          hx-target="#catalog-content"
                          hx-swap="outerHTML"
                          hx-push-url="true"
                          hx-indicator="#catalog-loading"
                        >
                          Вперёд
                        </button>
                      {% endif %}
                    </nav>
                  {% endif %}
                  <div
                    id="catalog-loading"
                    class="htmx-indicator absolute inset-0 z-20 flex items-center justify-center bg-paper/70 backdrop-blur-sm"
                    style="display: none;"
                    role="status"
                    aria-live="polite"
                    aria-atomic="true"
                  >
                    <div class="flex flex-col items-center gap-3 text-ink-muted">
                      <svg
                        class="h-10 w-10 animate-spin text-accent"
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                      >
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 0113.657-5.657l-2.829 2.829A4 4 0 008 12H4z"></path>
                      </svg>
                      <span class="text-sm">Ищем книги…</span>
                      <span class="sr-only">Идёт загрузка каталога</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% else %}
          <div data-name="home_page" class="space-y-16">
            {% include 'main/partials/_banner.html' with banners=banners %}

            {% if categories %}
              <section>
                <h2 class="text-2xl font-bold">Подборки</h2>
                
                <div class="mt-8 grid gap-6 sm:grid-cols-2 xl:grid-cols-3">
                  {% for category in categories %}
                    <a
                      href="{% url 'main:catalog' category.slug %}"
                      class="relative flex flex-col gap-1 overflow-hidden rounded-xl border border-accent-soft/60 bg-white p-6 transition hover:shadow-xl"
                    >
                      <img
                        src="{{ category.image.url }}"
                        alt="{{ category.name }}"
                        class="w-full h-auto object-cover rounded-xl"
                      >
                      <h3 class="text-2xl font-bold text-ink text-center mt-1">{{ category }}</h3>
                    </a>
                  {% endfor %}
                </div>
              </section>
            {% endif %}

            {% comment %} <section class="relative overflow-hidden rounded-2xl border border-accent-soft/50 bg-white p-7 lg:p-10">
              <div class="absolute inset-0"></div>
              <div class="relative grid gap-7 lg:grid-cols-[minmax(0,1.1fr)_minmax(0,0.9fr)]">
                <div class="space-y-6">
                  <p class="text-xs text-accent-darker">
                    Букинистический салон старинных книг и атрибутики
                  </p>
                  <h1 class="font-serif text-4xl leading-tight text-ink sm:text-5xl">
                    Атмосфера старой библиотеки <span class="text-accent-darker">в вашем экране</span>
                  </h1>
                  <p class="text-lg text-ink-muted">
                    Libra Antiqua — коллекция отобранных изданий, сохранивших тепло страниц и историю владельцев. Мы подбираем редкие книги, которые хочется держать в руках.
                  </p>
                  <div class="flex flex-wrap gap-4">
                    <a
                      href="{% url 'main:catalog_all' %}"
                      class="rounded-xl border border-accent-soft bg-accent px-6 py-3 text-sm font-semibold text-ink transition hover:bg-accent-dark hover:text-graphite"
                    >
                      Перейти в каталог
                    </a>
                    <a
                      href="#about"
                      class="rounded-xl border border-accent-darker px-6 py-3 text-sm font-semibold text-accent-darker transition hover:border-ink hover:bg-accent-soft/20 hover:text-ink"
                    >
                      О коллекции
                    </a>
                  </div>
                </div>
                <div class="relative">
                  <div class="absolute inset-0 translate-x-6 translate-y-6 rounded-3xl border border-accent-soft/70"></div>
                </div>
              </div>
            </section> {% endcomment %}

            {% include 'main/partials/_product-slider.html' with products=new_products title="Новинки" link=new_products_link %}

            <section id="about" class="grid gap-10 rounded-3xl border border-accent-soft/60 bg-white p-10 lg:grid-cols-2">
              <div class="space-y-4">
                <h2 class="text-3xl text-ink">Мы можем купить книги у вас </h2>
                <p class="text-base text-ink-muted">
                  Мы покупаем редкие и коллекционные издания у частных владельцев. После заявки куратор изучает описание и фото, оценивает рыночную стоимость и предлагает удобный формат сделки.
                </p>
                <ul class="space-y-3 text-sm text-ink">
                  <li class="flex items-start gap-3">
                    <span class="mt-1 h-2 w-2 rounded-full bg-graphite shrink-0"></span>
                    Вы присылаете описание и снимки, чтобы показать состояние переплёта, корешка и разворотов.
                  </li>
                  <li class="flex items-start gap-3">
                    <span class="mt-1 h-2 w-2 rounded-full bg-graphite shrink-0"></span>
                    Мы даём предварительную оценку в течение одного рабочего дня и уточняем детали.
                  </li>
                  <li class="flex items-start gap-3">
                    <span class="mt-1 h-2 w-2 rounded-full bg-graphite shrink-0"></span>
                    Согласовываем безопасную передачу и выплату — лично, курьером или по почте.
                  </li>
                </ul>
              </div>
              <div class="space-y-6 rounded-3xl border border-accent-soft/60 bg-white p-8">

                <p class="text-sm text-ink-muted">
                  Предложите книгу для нашей коллекции. Мы оценим состояние экземпляра по фото и свяжемся, чтобы обсудить условия выкупа.
                </p>
                {% if purchase_form_success %}
                  <div class="rounded-2xl border border-emerald-200 bg-emerald-50/80 px-4 py-3 text-sm text-emerald-900">
                    Спасибо! Мы получили заявку и ответим на указанные контакты в ближайший рабочий день.
                  </div>
                {% endif %}
                <form
                  action="{% url 'main:index' %}"
                  method="post"
                  enctype="multipart/form-data"
                  class="space-y-4"
                  novalidate
                >
                  {% csrf_token %}
                  {% if purchase_form.non_field_errors %}
                    <div class="rounded-2xl border border-red-200 bg-red-50 px-4 py-2 text-sm text-red-900">
                      {% for error in purchase_form.non_field_errors %}
                        <p>{{ error }}</p>
                      {% endfor %}
                    </div>
                  {% endif %}
                  <div>
                    <label for="{{ purchase_form.book_description.id_for_label }}" class="text-xs text-ink-muted">
                      {{ purchase_form.book_description.label }}
                    </label>
                    <textarea
                      id="{{ purchase_form.book_description.id_for_label }}"
                      name="{{ purchase_form.book_description.html_name }}"
                      rows="4"
                      placeholder="Расскажите об издании и его особенностях"
                      class="mt-2 w-full rounded-xl border border-accent/30 bg-white px-4 py-3 text-sm text-ink placeholder:text-ink-muted/70 focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/30"
                      required>{{ purchase_form.book_description.value|default_if_none:'' }}</textarea>
                    {% if purchase_form.book_description.errors %}
                      {% for error in purchase_form.book_description.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                      {% endfor %}
                    {% endif %}
                  </div>
                  <div>
                    <label for="{{ purchase_form.email.id_for_label }}" class="text-xs text-ink-muted">
                      {{ purchase_form.email.label }}
                    </label>
                    <input
                      id="{{ purchase_form.email.id_for_label }}"
                      type="email"
                      name="{{ purchase_form.email.html_name }}"
                      value="{{ purchase_form.email.value|default_if_none:'' }}"
                      placeholder="name@example.com"
                      class="mt-2 w-full rounded-xl border border-accent/30 bg-white px-4 py-2 text-sm text-ink placeholder:text-ink-muted/70 focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/30"
                      required
                    >
                    {% if purchase_form.email.errors %}
                      {% for error in purchase_form.email.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                      {% endfor %}
                    {% endif %}
                  </div>
                  <div>
                    <label for="{{ purchase_form.phone.id_for_label }}" class="text-xs text-ink-muted">
                      {{ purchase_form.phone.label }}
                    </label>
                    <input
                      id="{{ purchase_form.phone.id_for_label }}"
                      type="text"
                      name="{{ purchase_form.phone.html_name }}"
                      value="{{ purchase_form.phone.value|default_if_none:'' }}"
                      placeholder="+7 (900) 000-00-00"
                      class="mt-2 w-full rounded-xl border border-accent/30 bg-white px-4 py-2 text-sm text-ink placeholder:text-ink-muted/70 focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/30"
                      required
                    >
                    {% if purchase_form.phone.errors %}
                      {% for error in purchase_form.phone.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                      {% endfor %}
                    {% endif %}
                  </div>
                  <div>
                    <label for="{{ purchase_form.photos.id_for_label }}" class="text-xs text-ink-muted">
                      {{ purchase_form.photos.label }}
                    </label>
                    <input
                      id="{{ purchase_form.photos.id_for_label }}"
                      type="file"
                      name="{{ purchase_form.photos.html_name }}"
                      multiple
                      accept="image/*"
                      class="mt-2 block w-full rounded-xl border border-dashed border-accent/40 bg-accent-soft/20 px-4 py-3 text-sm text-ink"
                    >
                    <p class="mt-2 text-xs text-ink-muted">Можно прикрепить несколько фотографий обложки и разворотов.</p>
                    {% if purchase_form.photos.errors %}
                      {% for error in purchase_form.photos.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                      {% endfor %}
                    {% endif %}
                  </div>
                  <button
                    type="submit"
                    class="w-full rounded-xl border border-accent-soft bg-accent px-5 py-3 text-sm font-semibold text-ink transition hover:bg-accent-soft/80 hover:text-graphite"
                  >
                    Отправить заявку
                  </button>
                </form>
              </div>
            </section>
          </div>
        {% endif %}
      </section>
    </main>

    <section id="modal-root" class="mx-auto w-full my-container px-4 sm:px-6 lg:px-8" hx-target="this" hx-swap="innerHTML"></section>

    {% include 'layout/partials/_footer.html' %}
  </div>

  {% include 'layout/footer-scripts.html' %}
</body>
</html>
