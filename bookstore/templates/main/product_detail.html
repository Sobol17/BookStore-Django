{% load cart_tags %}
<div data-name="product_detail" class="space-y-14">
  <div class="grid gap-10 xl:grid-cols-[minmax(0,1.15fr)_minmax(0,0.85fr)]">
    <div class="space-y-6">
      <section class="rounded-3xl border border-accent-soft/60 bg-white p-4 md:p-6" data-gallery-root>
        <style>
          .thumb-tile {
            opacity: 0.6;
          }
          [data-gallery-root] .swiper-slide-thumb-active .thumb-tile {
            border-color: rgba(71, 169, 195, 1);
            box-shadow: 0 6px 16px rgba(71, 169, 195, 0.25);
            opacity: 1 !important;
          }
          [data-gallery-root] .thumbs-vertical .swiper-slide {
            padding-bottom: 0.75rem;
          }
          [data-gallery-root] .thumbs-vertical .swiper-slide:last-child {
            padding-bottom: 0;
          }
        </style>
        <div class="flex flex-col gap-4 md:flex-row md:items-start md:gap-5">
          {% if gallery_images|length > 1 %}
            <div class="hidden md:block md:w-[84px]">
              <div class="swiper js-product-gallery-thumbs h-full max-h-[400px] thumbs-vertical lg:max-h-[450px]" data-orientation="vertical">
                <div class="swiper-wrapper">
                  {% for image in gallery_images %}
                    <div class="swiper-slide cursor-pointer !h-[102px]">
                      <div class="thumb-tile h-[90px] lg:h-[102px] w-full overflow-hidden rounded-xl border border-accent-soft bg-white transition hover:border-accent">
                        <img
                          src="{{ image.url }}"
                          alt="{{ image.alt }}"
                          loading="lazy"
                          class="h-full w-full object-cover"
                        >
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          {% endif %}

          <div class="relative order-1 w-full max-w-[310px] sm:max-w-[380px] md:order-2 md:max-w-[520px] md:mx-0 mx-auto">
            <div class="pointer-events-none absolute left-4 top-4 z-10 flex flex-col gap-2 text-xs font-semibold">
              {% if object.collection %}
                <span class="inline-flex rounded-full bg-mint px-3 py-1 text-graphite shadow-sm">
                  {{ object.get_collection_display }}
                </span>
              {% else %}
                <span class="inline-flex rounded-full bg-mint px-3 py-1 text-graphite shadow-sm">
                  Новинка
                </span>
              {% endif %}
            </div>
            {% if discount_percent %}
              <span class="pointer-events-none absolute right-4 top-4 z-10 inline-flex rounded-full bg-blush px-3 py-1 text-xs font-bold text-white shadow-sm">
                -{{ discount_percent }}%
              </span>
            {% endif %}
            <div class="swiper js-product-gallery overflow-hidden rounded-2xl border border-accent/20 bg-accent-soft/40">
              <div class="swiper-wrapper">
                {% if gallery_images %}
                  {% for image in gallery_images %}
                    <div class="swiper-slide">
                      <div class="relative">
                        <div class="mx-auto flex h-[300px] w-[300px] items-center justify-center overflow-hidden shadow-sm sm:h-[340px] sm:w-[340px] md:h-[400px] md:w-[400px] lg:h-[450px] lg:w-[450px]">
                          <img
                            src="{{ image.url }}"
                            alt="{{ image.alt }}"
                            loading="lazy"
                            class="h-full w-full object-contain object-center transition duration-500"
                          >
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                {% else %}
                  <div class="swiper-slide">
                    <div class="relative">
                      <div class="mx-auto flex h-[300px] w-[300px] items-center justify-center rounded-2xl border border-dashed border-accent-soft bg-accent-soft text-sm text-ink-muted sm:h-[340px] sm:w-[340px] md:h-[400px] md:w-[400px] lg:h-[450px] lg:w-[450px]">
                        Нет изображения
                      </div>
                    </div>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        {% if gallery_images|length > 1 %}
          <div class="mt-4 md:hidden">
            <div class="swiper js-product-gallery-thumbs max-w-[310px] sm:max-w-[378px]" data-orientation="horizontal">
              <div class="swiper-wrapper">
                {% for image in gallery_images %}
                  <div class="swiper-slide cursor-pointer">
                    <div class="thumb-tile aspect-[3/4] h-[64px] overflow-hidden rounded-lg border border-accent-soft bg-white transition hover:border-accent">
                      <img
                        src="{{ image.url }}"
                        alt="{{ image.alt }}"
                        loading="lazy"
                        class="h-full w-full object-cover"
                      >
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        {% endif %}
      </section>

      <section class="rounded-3xl border border-accent-soft/60 bg-white p-4 md:p-6">
        <div class="flex items-center justify-between gap-4">
          <h2 class="text-lg font-semibold text-ink">Характеристики</h2>
          {% if object.stock_qty %}
            <span class="rounded-xl border border-accent-soft bg-accent-soft/40 px-3 py-1 text-xs font-semibold text-graphite">
              {{ object.stock_qty }} шт. в наличии
            </span>
          {% endif %}
        </div>
        <dl class="mt-4 grid gap-4 text-sm text-ink-muted sm:grid-cols-2">
          {% if object.condition %}
            <div>
              <dt class="font-semibold text-ink">Состояние</dt>
              <dd class="mt-1">{{ object.get_condition_display }}</dd>
            </div>
          {% endif %}
          {% if object.isbn %}
            <div>
              <dt class="font-semibold text-ink">ISBN</dt>
              <dd class="mt-1">{{ object.isbn }}</dd>
            </div>
          {% endif %}
          {% if object.year %}
            <div>
              <dt class="font-semibold text-ink">Год издания</dt>
              <dd class="mt-1">{{ object.year }}</dd>
            </div>
          {% endif %}
          {% if object.publisher %}
            <div>
              <dt class="font-semibold text-ink">Издательство</dt>
              <dd class="mt-1">{{ object.publisher }}</dd>
            </div>
          {% endif %}
          {% if object.genre %}
            <div>
              <dt class="font-semibold text-ink">Жанр</dt>
              <dd class="mt-1">{{ object.genre.name }}</dd>
            </div>
          {% endif %}
          {% if object.weight_g %}
            <div>
              <dt class="font-semibold text-ink">Вес</dt>
              <dd class="mt-1">{{ object.weight_g }} г</dd>
            </div>
          {% endif %}
        </dl>
      </section>
    </div>

    <aside class="space-y-6">
      <section class="flex flex-col gap-8 rounded-3xl border border-accent-soft/60 bg-white p-4 md:p-8">
        <div>
          <p class="text-xs text-graphite">
            {% if object.category %}{{ object.category.name }}{% else %}Редкое издание{% endif %}
          </p>
          <h1 class="mt-2 md:mt-3 font-semibold text-2xl md:text-4xl leading-tight text-ink">
            {{ object.name }}
          </h1>
          {% if object.authors %}
            <p class="mt-2 md:mt-3 text-sm text-ink-muted">
              Авторы: {{ object.authors }}
            </p>
          {% endif %}
          <div class="mt-2 md:mt-4 text-sm text-ink-muted">
            {% with total_reviews=reviews_count|default:reviews_total %}
              {% if total_reviews %}
                <div class="flex flex-wrap items-center gap-3">
                  <div class="flex items-center gap-1 text-lg leading-none">
                    {% for star in rating_stars %}
                      {% if star == 'full' %}
                        <span class="text-amber-500">★</span>
                      {% elif star == 'half' %}
                        <span class="bg-gradient-to-r from-accent to-accent-dark bg-clip-text text-transparent">★</span>
                      {% else %}
                        <span class="text-ink-muted/40">★</span>
                      {% endif %}
                    {% endfor %}
                  </div>
                  {% if rating_value %}
                    <span class="font-semibold text-graphite">{{ rating_value|floatformat:1 }}</span>
                  {% endif %}
                  <span>
                    {% if total_reviews == 1 %}
                      1 отзыв
                    {% elif total_reviews < 5 %}
                      {{ total_reviews }} отзыва
                    {% else %}
                      {{ total_reviews }} отзывов
                    {% endif %}
                  </span>
                </div>
              {% else %}
                <span>Отзывов пока нет</span>
              {% endif %}
            {% endwith %}
          </div>
        </div>

        <div class="rounded-2xl border border-accent-soft bg-accent-soft/60 p-4 md:p-6">
          <p class="text-xs">Стоимость экземпляра</p>
          <div class="mt-3 flex flex-wrap items-baseline gap-4">
            <p class="text-3xl font-semibold text-ink">{{ object.formatted_price }}</p>
            {% if object.old_price %}
              <span class="text-sm text-ink-muted line-through">{{ object.formatted_old_price }}</span>
            {% endif %}
          </div>
          <div class="mt-6 flex flex-col gap-3 sm:flex-row sm:items-center">
            <div id="product-cart-action" class="w-full sm:w-auto">
              <div id="product-cart-add" class="{% if product_cart_item %}hidden{% endif %}">
                <button
                  type="button"
                  onclick="addToCart()"
                  class="w-full rounded-xl border border-accent-soft bg-accent px-6 py-3 text-sm font-semibold text-ink transition hover:bg-accent-dark hover:text-graphite"
                >
                  В корзину
                </button>
              </div>
              <div
                id="product-cart-quantity-wrapper"
                class="{% if not product_cart_item %}hidden{% endif %}"
                data-cart-item-id="{% if product_cart_item %}{{ product_cart_item.id }}{% endif %}"
                data-update-url-template="{% url 'cart:update_item' 0 %}"
              >
                <div class="flex items-center justify-between rounded-xl border border-accent-soft bg-white px-2 py-1 gap-x-4">
                  <button
                    type="button"
                    class="h-12 w-12 rounded-xl border border-accent-soft text-2xl font-semibold text-ink transition hover:bg-accent-soft"
                    onclick="changeProductQuantity(-1)"
                    aria-label="Уменьшить количество"
                  >
                    −
                  </button>
                  <span id="product-cart-quantity-value" class="text-lg font-semibold text-ink">{{ product_cart_item.quantity|default:1 }}</span>
                  <button
                    type="button"
                    class="h-12 w-12 rounded-xl border border-accent-soft text-2xl font-semibold text-ink transition hover:bg-accent-soft"
                    onclick="changeProductQuantity(1)"
                    aria-label="Увеличить количество"
                  >
                    +
                  </button>
                </div>
              </div>
            </div>
            {% with favorite=favorite_items_map|dict_get:object.id %}
              <button
                type="button"
                class="favorite-toggle inline-flex items-center justify-center rounded-xl border border-accent-soft px-4 py-3 text-sm text-ink transition hover:border-accent hover:bg-accent-soft/60 {% if favorite %}favorite-active{% endif %}"
                data-favorite-button
                data-product-id="{{ object.id }}"
                data-favorite-url="{% url 'favorites:toggle' object.slug %}"
                data-favorite-active="{% if favorite %}true{% else %}false{% endif %}"
                aria-label="Добавить в избранное"
                aria-pressed="{% if favorite %}true{% else %}false{% endif %}"
              >
                <i data-lucide="heart" class="h-5 w-5"></i>
              </button>
            {% endwith %}
          </div>
        <button
          type="button"
          class="mt-4 w-full rounded-xl border border-accent px-6 py-3 text-xs font-semibold text-graphite transition hover:bg-accent-soft sm:w-auto"
          hx-get="{% url 'main:product_stock_notify' object.slug %}"
          hx-target="#modal-root"
          hx-swap="innerHTML"
        >
          Сообщить о поступлении
        </button>
          <p class="mt-4 flex items-center gap-2 text-xs text-ink-muted">
            <i data-lucide="clock" class="h-4 w-4"></i>
            Отправим заказ в течение 3 рабочих дней
          </p>
        </div>

        {% if object.description %}
          <article class="prose prose-sm max-w-none prose-headings:font-serif prose-headings:text-ink prose-p:text-ink-muted prose-strong:text-ink">
            {{ object.description|linebreaks }}
          </article>
        {% endif %}
      </section>
    </aside>
  </div>

  {% include 'main/partials/_product_reviews.html' %}

  {% if related_products %}
    {% include 'main/partials/_product-slider.html' with products=related_products title="Похожие издания" link=None %}
  {% endif %}

  <section class="rounded-3xl border border-accent-soft/60 bg-white p-4 md:p-8">
    <div class="flex flex-wrap items-center justify-between gap-4">
      <h2 class="font-semibold text-xl md:text-2xl text-ink">Рецензия</h2>
      <form
        method="post"
        class="flex items-center"
        hx-post="{% url 'main:product_deepseek_review' object.slug %}"
        hx-target="#ai-review-content"
        hx-swap="innerHTML"
        hx-indicator="#ai-review-loading"
        hx-on::before-request="var loader=document.getElementById('ai-review-loading');if(loader){loader.style.display='flex';}var trigger=document.getElementById('ai-review-trigger');if(trigger){trigger.style.display='none';}"
        hx-on::after-request="var loader=document.getElementById('ai-review-loading');if(loader){loader.style.display='none';}var trigger=document.getElementById('ai-review-trigger');if(trigger){trigger.style.display='';}"
      >
        {% csrf_token %}
        <button
          type="submit"
          id="ai-review-trigger"
          class="rounded-xl border border-accent-soft bg-accent px-6 py-3 text-sm font-semibold text-ink transition hover:bg-accent-dark hover:text-graphite {% if not can_request_ai_review %}cursor-not-allowed opacity-50 hover:bg-accent{% endif %}"
          {% if not can_request_ai_review %}disabled aria-disabled="true"{% endif %}
        >
          Получить
        </button>
      </form>
    </div>
    {% if not can_request_ai_review %}
      <p class="mt-2 text-xs text-ink-muted">
        Интеграция DeepSeek ещё не активирована — запрос временно недоступен.
      </p>
    {% endif %}
    <div
      id="ai-review-loading"
      class="htmx-indicator mt-4 flex items-center gap-3 rounded-2xl border border-accent-soft/80 bg-accent-soft/50 px-4 py-3 text-xs text-ink-muted"
      style="display: none;"
      role="status"
      aria-live="polite"
      aria-atomic="true"
    >
      <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-white">
        <span class="h-4 w-4 animate-spin rounded-full border-2 border-accent border-t-transparent"></span>
      </span>
      <div class="flex flex-col text-sm">
        <span class="font-semibold text-ink">Рецензия генерируется…</span>
        <span>DeepSeek подбирает выразительное описание, подождите пару секунд.</span>
      </div>
    </div>
    <div id="ai-review-content" class="mt-4 text-sm leading-relaxed text-ink">
      {% include 'main/partials/_product_ai_review.html' with product=object review_text=None error=None initial=True %}
    </div>
  </section>

  {% if seo_text %}
    <section class="rounded-3xl border border-accent-soft/60 bg-white p-4 md:p-8">
      <h2 class="font-semibold text-xl md:text-2xl text-ink">Описание</h2>
      <div class="prose prose-sm mt-4 max-w-none prose-headings:font-serif prose-headings:text-ink prose-p:text-ink-muted prose-strong:text-ink">
        {{ seo_text|linebreaks }}
      </div>
    </section>
  {% endif %}
</div>

<script>
function getProductCartQuantityWrapper() {
    return document.getElementById('product-cart-quantity-wrapper');
}

function showProductAddButton() {
    const addWrapper = document.getElementById('product-cart-add');
    const quantityWrapper = getProductCartQuantityWrapper();
    if (quantityWrapper) {
        quantityWrapper.classList.add('hidden');
        quantityWrapper.dataset.cartItemId = '';
    }
    if (addWrapper) {
        addWrapper.classList.remove('hidden');
    }
}

function showProductQuantityControls(cartItemId, quantity) {
    const addWrapper = document.getElementById('product-cart-add');
    const quantityWrapper = getProductCartQuantityWrapper();
    const quantityValue = document.getElementById('product-cart-quantity-value');
    if (!quantityWrapper || !quantityValue) {
        return;
    }
    quantityWrapper.classList.remove('hidden');
    quantityWrapper.dataset.cartItemId = cartItemId;
    quantityValue.textContent = quantity;
    if (addWrapper) {
        addWrapper.classList.add('hidden');
    }
}

function changeProductQuantity(delta) {
    const quantityWrapper = getProductCartQuantityWrapper();
    const quantityValue = document.getElementById('product-cart-quantity-value');
    if (!quantityWrapper || !quantityValue) {
        return;
    }
    const cartItemId = quantityWrapper.dataset.cartItemId;
    if (!cartItemId) {
        return;
    }
    const currentQuantity = parseInt(quantityValue.textContent, 10) || 0;
    const nextQuantity = currentQuantity + delta;
    updateProductCartQuantity(cartItemId, nextQuantity);
}

function updateProductCartQuantity(cartItemId, newQuantity) {
    const quantityWrapper = getProductCartQuantityWrapper();
    if (!quantityWrapper) {
        return;
    }
    if (newQuantity < 0) {
        newQuantity = 0;
    }
    const urlTemplate = quantityWrapper.dataset.updateUrlTemplate;
    if (!urlTemplate) {
        return;
    }
    const url = urlTemplate.replace('/0/', `/${cartItemId}/`);
    const formData = new FormData();
    formData.append('quantity', newQuantity);
    fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showNotification(data.error);
            return;
        }
        updateHeaderCartCount(data.total_items);
        if (data.removed) {
            showProductAddButton();
        } else {
            const updatedId = data.cart_item_id || cartItemId;
            const displayedQuantity = data.quantity != null ? data.quantity : newQuantity;
            showProductQuantityControls(updatedId, displayedQuantity);
        }
    })
    .catch(error => {
        console.error('Error updating cart item', error);
        showNotification('Не удалось обновить корзину');
    });
}

    function addToCart() {
    const productSlug = '{{ product.slug }}';
    console.log('Product Slug:', productSlug);

    let formData = new FormData();
    formData.append('quantity', '1');
    fetch(`{% url 'cart:add_to_cart' 'PLACEHOLDER' %}`.replace('PLACEHOLDER', productSlug), {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        console.log('Response Status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Response Data:', data);
        if (data.error) {
            showNotification(data.error);
        } else {
            updateHeaderCartCount(data.total_items);
            showNotification(data.message);
            showProductQuantityControls(data.cart_item_id, data.quantity || 1);
            htmx.ajax('GET', '{% url "cart:cart_modal" %}', {
                target: '#cart-container',
                swap: 'innerHTML'
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error adding to cart');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'fixed top-20 right-4 bg-black text-white px-6 py-3 rounded shadow-lg z-50 transform translate-x-full transition-transform duration-300';
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 10);
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, 3000);
}

document.body.addEventListener('cart-updated', function(event) {
    const detail = event.detail || {};
    if (detail && typeof detail.total_items !== 'undefined' && typeof updateHeaderCartCount === 'function') {
        updateHeaderCartCount(detail.total_items);
    }
    if (!detail || detail.product_slug !== '{{ object.slug }}') {
        return;
    }
    const quantity = parseInt(detail.quantity, 10) || 0;
    if (quantity > 0) {
        showProductQuantityControls(detail.cart_item_id || '', quantity);
    } else {
        showProductAddButton();
    }
});

</script>
