<aside class="space-y-6 rounded-3xl border border-accent-soft/60 bg-white p-6 self-start w-[275px]">
  <h2 class="text-xl font-semibold text-ink">Фильтры</h2>
  <form
    action="."
    method="get"
    class="space-y-4"
    hx-get="{{ request.path }}"
    hx-target="#catalog-content"
    hx-swap="outerHTML"
    hx-push-url="true"
    hx-indicator="#catalog-loading"
  >
    <input type="hidden" name="sort" value="{{ current_sort|default:'popular' }}">
    <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-1">
      <div class="sm:col-span-2 lg:col-span-1 space-y-3">
        <div class="flex items-center gap-2">
          <span class="text-sm font-semibold text-ink">Цена</span>
          <i data-lucide="info" class="h-4 w-4 text-ink-muted"></i>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <input
            type="number"
            name="min_price"
            inputmode="numeric"
            min="0"
            placeholder="{{ price_bounds.min }}"
            value="{{ filter_params.min_price }}"
            class="input"
          >
          <input
            type="number"
            name="max_price"
            inputmode="numeric"
            min="0"
            placeholder="{{ price_bounds.max }}"
            value="{{ filter_params.max_price }}"
            class="input"
          >
        </div>
        <div class="space-y-2">
          {% for preset in price_bounds.presets %}
            <label class="flex items-center gap-2 rounded-xl border border-accent-soft/60 px-3 py-2 text-sm font-medium text-ink transition hover:border-accent hover:bg-accent-soft/40">
              <input
                type="radio"
                name="price_range"
                value="{{ preset.key }}"
                class="h-4 w-4 focus:ring-accent"
                {% if filter_params.price_range == preset.key %}checked{% endif %}
              >
              <span>{{ preset.label }}</span>
            </label>
          {% endfor %}
          <label class="flex items-center gap-2 rounded-xl border border-accent-soft/60 px-3 py-2 text-sm font-medium text-ink transition hover:border-accent hover:bg-accent-soft/40">
            <input
              type="radio"
              name="price_range"
              value=""
              class="h-4 w-4 text-accent focus:ring-accent"
              {% if not filter_params.price_range %}checked{% endif %}
            >
            <span>Неважно</span>
          </label>
        </div>
      </div>

      <div class="space-y-3">
        <div class="flex items-center gap-2">
          <span class="text-sm font-semibold text-ink">Год издания</span>
          <i data-lucide="info" class="h-4 w-4 text-ink-muted"></i>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <input
            type="number"
            name="min_year"
            inputmode="numeric"
            placeholder="{{ year_bounds.min }}"
            value="{{ filter_params.min_year }}"
            class="input"
          >
          <input
            type="number"
            name="max_year"
            inputmode="numeric"
            placeholder="{{ year_bounds.max }}"
            value="{{ filter_params.max_year }}"
            class="input"
          >
        </div>
        <div class="space-y-2">
          {% for preset in year_bounds.presets %}
            <label class="flex items-center gap-2 rounded-xl border border-accent-soft/60 px-3 py-2 text-sm font-medium text-ink transition hover:border-accent hover:bg-accent-soft/40">
              <input
                type="radio"
                name="year_range"
                value="{{ preset.key }}"
                class="h-4 w-4 text-accent focus:ring-accent"
                {% if filter_params.year_range == preset.key %}checked{% endif %}
              >
              <span>{{ preset.label }}</span>
            </label>
          {% endfor %}
          <label class="flex items-center gap-2 rounded-xl border border-accent-soft/60 px-3 py-2 text-sm font-medium text-ink transition hover:border-accent hover:bg-accent-soft/40">
            <input
              type="radio"
              name="year_range"
              value=""
              class="h-4 w-4 text-accent focus:ring-accent"
              {% if not filter_params.year_range %}checked{% endif %}
            >
            <span>Неважно</span>
          </label>
        </div>
      </div>
      <div class="space-y-3" data-author-filter>
        <div class="flex items-center justify-between">
          <span class="text-sm font-semibold text-ink">Автор</span>
          {% if selected_authors %}
            <span class="rounded-full bg-accent-soft px-2 py-0.5 text-xs font-semibold text-ink">{{ selected_authors|length }}</span>
          {% endif %}
        </div>
        <div class="relative">
          <input
            type="text"
            placeholder="Найти"
            class="input"
            data-author-search
            autocomplete="off"
          >
          <i data-lucide="search" class="pointer-events-none absolute right-3 top-1/2 h-4 w-4 -translate-y-1/2 text-ink-muted"></i>
        </div>
        <div class="max-h-48 overflow-hidden space-y-2 transition-[max-height]" data-author-list data-collapsed="true">
          {% for author in authors %}
            <label class="flex items-start gap-2 text-sm text-ink">
              <input
                type="checkbox"
                name="author"
                value="{{ author }}"
                class="mt-1 h-4 w-4 rounded border-accent-soft text-accent focus:ring-accent"
                {% if author in selected_authors %}checked{% endif %}
                data-author-name="{{ author|lower }}"
              >
              <span class="leading-tight">{{ author }}</span>
            </label>
          {% empty %}
            <p class="text-sm text-ink-muted">Авторы не найдены.</p>
          {% endfor %}
        </div>
        {% if authors|length > 5 %}
          <button type="button" class="text-sm font-semibold text-accent transition hover:text-graphite" data-author-toggle>
            Посмотреть все
          </button>
        {% endif %}
      </div>
    </div>
    <div class="flex flex-wrap gap-3">
      <button
        type="submit"
        class="w-full rounded-lg border border-accent bg-accent px-5 py-2 text-sm font-semibold text-ink transition hover:bg-accent-dark"
      >
        Применить
      </button>
      <a
        href="{% url 'main:catalog_all' %}"
        hx-get="{% url 'main:catalog_all' %}"
        hx-target="#catalog-content"
        hx-swap="outerHTML"
        hx-push-url="true"
        hx-indicator="#catalog-loading"
        class="w-full rounded-lg border border-accent px-5 py-2 text-center text-sm font-semibold text-graphite transition hover:bg-accent-soft"
      >
        Сбросить
      </a>
    </div>
  </form>
</aside>

<script>
(() => {
  if (window.initAuthorFilters) {
    document.addEventListener('DOMContentLoaded', window.initAuthorFilters);
    document.body.addEventListener('htmx:afterSwap', window.initAuthorFilters);
    return;
  }

  function initAuthorFilters() {
    document.querySelectorAll('[data-author-filter]').forEach((root) => {
      const searchInput = root.querySelector('[data-author-search]');
      const list = root.querySelector('[data-author-list]');
      const toggle = root.querySelector('[data-author-toggle]');
      const checkboxInputs = list ? Array.from(list.querySelectorAll('[data-author-name]')) : [];

      const applyFilter = () => {
        const term = (searchInput && searchInput.value || '').trim().toLowerCase();
        checkboxInputs.forEach((input) => {
          const row = input.closest('label');
          const matches = !term || input.dataset.authorName.includes(term);
          if (row) {
            row.style.display = matches ? '' : 'none';
          }
        });
      };

      if (searchInput) {
        searchInput.addEventListener('input', applyFilter);
      }

      if (toggle && list) {
        const collapsedClass = 'max-h-48';
        const expandedClass = 'max-h-96';
        const setState = (collapsed) => {
          list.dataset.collapsed = collapsed ? 'true' : 'false';
          list.classList.toggle(collapsedClass, collapsed);
          list.classList.toggle(expandedClass, !collapsed);
          toggle.textContent = collapsed ? 'Посмотреть все' : 'Свернуть';
        };
        setState(true);
        toggle.addEventListener('click', () => setState(list.dataset.collapsed === 'false'));
      }
    });
  }

  window.initAuthorFilters = initAuthorFilters;
  document.addEventListener('DOMContentLoaded', initAuthorFilters);
  document.body.addEventListener('htmx:afterSwap', initAuthorFilters);
})();
</script>
