{% load static %}

{% include 'layout/head-metrics.html' %}

<body class="min-h-screen font-sans text-ink antialiased">
  <div class="min-h-screen bg-paper">
    {% include 'layout/partials/_header.html' %}

    <main class="mx-auto flex w-full my-container flex-1 flex-col px-4 py-10 sm:px-6 lg:px-8">
      <div class="grid gap-8 lg:grid-cols-[1fr_1fr] items-start">
        <section class="rounded-3xl border border-accent-soft/60 bg-gradient-to-br from-coffee via-coffee/95 to-graphite p-8 text-white shadow-lamplight">
          <div class="flex flex-col gap-6">
            <div>
              <p class="text-sm font-semibold text-accent">Зачем регистрироваться</p>
              <h2 class="mt-3 text-4xl font-serif leading-tight">Создайте профиль</h2>
              <p class="mt-4 text-base text-white/80">Мы сохраняем вашу историю заказов и предпочитаемые жанры, чтобы предлагать действительно редкие находки.</p>
            </div>

            <div class="space-y-5">
              <article class="rounded-2xl border border-white/20 bg-white/5 p-5">
                <p class="text-sm font-semibold uppercase tracking-[0.1em] text-accent">01</p>
                <h3 class="mt-3 text-xl font-semibold">Персональные предложения</h3>
                <p class="mt-2 text-sm text-white/75">Получайте подборки от наших кураторов и узнавайте о поступлениях первыми.</p>
              </article>
              <article class="rounded-2xl border border-white/20 bg-white/5 p-5">
                <p class="text-sm font-semibold uppercase tracking-[0.1em] text-accent">02</p>
                <h3 class="mt-3 text-xl font-semibold">Сохранение адресов</h3>
                <p class="mt-2 text-sm text-white/75">Храните несколько адресов и переключайте их в один клик при оформлении.</p>
              </article>
              <article class="rounded-2xl border border-white/20 bg-white/5 p-5">
                <p class="text-sm font-semibold uppercase tracking-[0.1ем] text-accent">03</p>
                <h3 class="mt-3 text-xl font-semibold">Контроль заказов</h3>
                <p class="mt-2 text-sm text-white/75">Проверяйте статусы заказов и повторяйте заказы из истории.</p>
              </article>
            </div>
          </div>
        </section>

        <section id="register-card" class="rounded-3xl border border-accent-soft/70 bg-white/95 p-8 shadow-card">
          <p class="text-xs font-semibold uppercase text-ink-muted">Регистрация</p>
          <h1 class="mt-3 text-3xl font-semibold text-ink">Создайте профиль</h1>
          <p class="mt-2 text-sm text-ink-muted">Заполните данные и выберите способ подтверждения: email или телефон.</p>

          {% if messages %}
            <div class="mt-6 space-y-2">
              {% for message in messages %}
                {% if 'error' in message.tags %}
                  <p class="rounded-2xl border border-blush/50 bg-blush/10 px-4 py-2 text-sm font-medium text-blush">{{ message }}</p>
                {% else %}
                  <p class="rounded-2xl border border-mint/60 bg-mint/10 px-4 py-2 text-sm font-medium text-ink">{{ message }}</p>
                {% endif %}
              {% endfor %}
            </div>
          {% endif %}

          <div class="mt-8 space-y-8">
            <div class="rounded-2xl border border-accent-soft/70 bg-accent-soft/20 p-5 md:p-6">
              <h3 class="text-xl font-semibold text-ink">Регистрация</h3>
              <form method="post" action="{% url 'users:register' %}" class="mt-4 space-y-4">
                {% csrf_token %}
                <div class="space-y-2">
                  <label for="{{ form.first_name.id_for_label }}" class="text-sm font-medium text-ink block">Имя</label>
                  {{ form.first_name }}
                  {% if form.first_name.errors %}
                    <p class="text-sm text-blush">{{ form.first_name.errors|striptags }}</p>
                  {% endif %}
                </div>
                <div class="space-y-2">
                  <label for="{{ form.phone.id_for_label }}" class="text-sm font-medium text-ink block">Телефон</label>
                  {{ form.phone }}
                  {% if form.phone.errors %}
                    <p class="text-sm text-blush">{{ form.phone.errors|striptags }}</p>
                  {% else %}
                    <p class="text-xs text-ink-muted">Для подтверждения по телефону потребуется код 1234.</p>
                  {% endif %}
                </div>
                <div class="space-y-2">
                  <label for="{{ form.email.id_for_label }}" class="text-sm font-medium text-ink block">Email</label>
                  {{ form.email }}
                  {% if form.email.errors %}
                    <p class="text-sm text-blush">{{ form.email.errors|striptags }}</p>
                  {% else %}
                    <p class="text-xs text-ink-muted">Для подтверждения по email отправим ссылку.</p>
                  {% endif %}
                </div>
                <div class="space-y-2">
                  <label class="text-sm font-medium text-ink block">Способ подтверждения</label>
                  {{ form.confirm_method }}
                </div>
                <div class="space-y-3" data-sms-section>
                  <div class="space-y-2">
                    <label for="{{ form.sms_code.id_for_label }}" class="text-sm font-medium text-ink block">Код из SMS</label>
                    {{ form.sms_code }}
                    {% if form.sms_code.errors %}
                      <p class="text-sm text-blush">{{ form.sms_code.errors|striptags }}</p>
                    {% else %}
                      <p class="text-xs text-ink-muted">Для тестирования используйте код <span class="font-semibold">1234</span>.</p>
                    {% endif %}
                  </div>
                  <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
                    <button type="button" data-send-sms class="inline-flex items-center justify-center rounded-xl bg-ink px-5 py-2 text-sm font-semibold text-white transition hover:bg-ink/90">Отправить код</button>
                    <p class="text-xs text-ink-muted" data-sms-status>Введите телефон и отправьте код для подтверждения.</p>
                  </div>
                </div>
                <p class="text-xs text-ink-muted/80">
                  Отправляя форму, вы подтверждаете своё согласие с <a href="/privacy" class="text-ink underline decoration-accent">политикой конфиденциальности</a> и условиями сервиса.
                </p>
                <div class="flex flex-col gap-3">
                  <button type="submit" class="rounded-xl bg-accent px-6 py-3 text-sm font-semibold text-graphite transition hover:bg-accent-dark">Создать аккаунт</button>
                  <a href="{% url 'users:login' %}" class="inline-flex items-center justify-center rounded-xl border border-accent-soft px-6 py-3 text-sm font-semibold text-ink transition hover:border-accent hover:bg-accent-soft/50">Уже есть аккаунт? Войти</a>
                </div>
              </form>
            </div>
          </div>
        </section>
      </div>
    </main>

    <section id="modal-root" class="mx-auto w-full my-container px-4 sm:px-6 lg:px-8" hx-target="this" hx-swap="innerHTML"></section>

    {% include 'layout/partials/_footer.html' %}
  </div>

  {% include 'layout/footer-scripts.html' %}
  <script>
    (function() {
      var confirmSelect;
      var smsSection;
      var sendButton;
      var statusEl;
      var phoneInput;
      var formEl;

      function initElements() {
        confirmSelect = document.querySelector('select[name="confirm_method"]');
        smsSection = document.querySelector('[data-sms-section]');
        sendButton = document.querySelector('[data-send-sms]');
        statusEl = document.querySelector('[data-sms-status]');
        phoneInput = document.querySelector('input[name="phone"]');
        formEl = document.querySelector('#register-card form');
      }

      function toggleSmsSection() {
        if (!smsSection) return;
        var method = confirmSelect ? confirmSelect.value : 'email';
        smsSection.style.display = method === 'phone' ? '' : 'none';
      }

      function setStatus(message, variant) {
        if (!statusEl) return;
        statusEl.textContent = message;
        statusEl.classList.remove('text-ink-muted', 'text-blush', 'text-mint');
        if (variant === 'error') {
          statusEl.classList.add('text-blush');
        } else if (variant === 'success') {
          statusEl.classList.add('text-mint');
        } else {
          statusEl.classList.add('text-ink-muted');
        }
      }

      function requestSmsCode() {
        if (!confirmSelect || confirmSelect.value !== 'phone') {
          setStatus('Выберите подтверждение по телефону.', 'error');
          return;
        }
        if (!phoneInput || !phoneInput.value.trim()) {
          setStatus('Укажите номер телефона.', 'error');
          return;
        }
        if (!formEl) return;
        var csrfInput = formEl.querySelector('input[name="csrfmiddlewaretoken"]');
        if (!csrfInput) return;

        sendButton.disabled = true;
        setStatus('Отправляем код...', 'info');

        var body = new URLSearchParams({
          phone: phoneInput.value,
          flow: 'register'
        });

        fetch("{% url 'users:request_sms_code' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfInput.value,
          },
          body: body.toString(),
        })
          .then(function(response) {
            return response.json().then(function(data) {
              return { ok: response.ok, data: data };
            });
          })
          .then(function(result) {
            if (result.ok && result.data && result.data.ok) {
              setStatus(result.data.message || 'Код отправлен. Для тестирования используйте 1234.', 'success');
            } else {
              var message = (result.data && result.data.message) || 'Не удалось отправить код.';
              setStatus(message, 'error');
            }
          })
          .catch(function() {
            setStatus('Не удалось отправить код. Попробуйте позже.', 'error');
          })
          .finally(function() {
            sendButton.disabled = false;
          });
      }

      document.addEventListener('DOMContentLoaded', function() {
        initElements();
        if (confirmSelect) {
          confirmSelect.addEventListener('change', toggleSmsSection);
        }
        if (sendButton) {
          sendButton.addEventListener('click', requestSmsCode);
        }
        toggleSmsSection();
      });
    })();
  </script>
</body>
</html>
