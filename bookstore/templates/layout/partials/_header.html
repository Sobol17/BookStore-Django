{% load static %}
<header class="sticky top-0 z-40 px-4 pt-3 sm:px-6 lg:px-8" x-data="{ mobileOpen: false, mobileSearchOpen: false }" data-sticky-header>
  <div class="mx-auto w-full my-container rounded-[1.5rem] bg-white/95 px-4 md:px-8 py-6 ring-1 ring-accent-soft/70 backdrop-blur-sm shadow-sm transition-all duration-200">
    <div class="flex flex-wrap items-center gap-4 pb-5" data-header-top>

      {% comment %} <div class="hidden md:flex items-center gap-2 text-sm text-ink-muted">
        <i data-lucide="map-pin" class="h-4 w-4 text-accent"></i>
        <span>–†–æ—Å—Å–∏—è, –ú–æ—Å–∫–≤–∞</span>
      </div> {% endcomment %}

      <nav class="hidden items-center gap-6 text-sm text-ink-muted xl:flex">
        <a href="{% url 'main:index' %}" class="transition hover:text-ink {% if not is_catalog_page and not object %}text-ink{% endif %}">–ì–ª–∞–≤–Ω–∞—è</a>
        <a href="{% url 'main:catalog_all' %}" class="transition hover:text-ink {% if is_catalog_page %}text-ink{% endif %}">–ó–∞–∫—É–ø–∫–∞ –∫–Ω–∏–≥</a>
        <a href="/about" class="transition hover:text-ink">–û –º–∞–≥–∞–∑–∏–Ω–µ</a>
        <a href="/about" class="transition hover:text-ink">–°–≤—è–∑–∞—Ç—å—Å—è</a>
      </nav>
    </div>
    <div class="flex items-center gap-3 md:hidden mb-5">
      <a href="{% url 'main:index' %}" class="flex flex-col leading-tight text-ink">
        <span class="text-[0.43rem] font-semibold text-accent-dark">–ë—É–∫–∏–Ω–∏—Å—Ç–∏–∫–∞</span>
        <span class="text-xl font-black tracking-[0.05em]">DOMBB</span>
      </a>
      <div class="flex-grow flex items-center gap-4">
        <div class="flex items-center gap-2">
          <button
            type="button"
            class="inline-flex h-11 w-11 items-center justify-center rounded-2xl bg-ink/5 text-ink transition hover:bg-ink/10"
            x-on:click="mobileSearchOpen = true; mobileOpen = false"
            aria-label="–û—Ç–∫—Ä—ã—Ç—å –ø–æ–∏—Å–∫"
          >
            <i data-lucide="search" class="h-5 w-5"></i>
          </button>
          <a
            class="inline-flex h-11 w-11 items-center justify-center rounded-2xl bg-accent text-ink transition hover:bg-accent-dark"
            href="{% url 'main:catalog_all' %}"
            aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é"
          >
            <i data-lucide="grid-3x3" class="h-5 w-5"></i>
          </a>
        </div>
        <div class="ml-auto flex items-center gap-1 border-l border-accent-soft/60 text-ink-muted">
          <a href="/favorites/" class="inline-flex h-8 w-8 sm:h-10 sm:w-10 items-center justify-center rounded-full transition hover:text-ink" aria-label="–ó–∞–∫–ª–∞–¥–∫–∏">
            <i data-lucide="bookmark" class="h-5 w-5"></i>
          </a>
          <button
            type="button"
            class="inline-flex h-8 w-8 sm:h-10 sm:w-10 items-center justify-center rounded-full transition hover:text-ink"
            aria-label="–ö–æ—Ä–∑–∏–Ω–∞"
            onclick="openCart()"
          >
            <i data-lucide="shopping-bag" class="h-5 w-5"></i>
            <span id="mobileCart" class="sr-only">–ö–æ—Ä–∑–∏–Ω–∞</span>
          </button>
          {% if request.user.is_authenticated %}
            <a href="{% url 'users:profile' %}" class="inline-flex h-8 w-8 sm:h-10 sm:w-10 items-center justify-center rounded-full transition hover:text-ink" aria-label="–ü—Ä–æ—Ñ–∏–ª—å">
              <i data-lucide="user-round" class="h-5 w-5"></i>
            </a>
          {% else %}
            <a href="{% url 'users:login' %}" class="inline-flex h-8 w-8 sm:h-10 sm:w-10 items-center justify-center rounded-full transition hover:text-ink" aria-label="–í–æ–π—Ç–∏">
              <i data-lucide="user-round" class="h-5 w-5"></i>
            </a>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="hidden gap-3 md:flex md:items-center">
      <a href="{% url 'main:index' %}" class="flex-col leading-tight text-ink hidden md:flex">
        <span class="text-[0.83rem] font-semibold text-accent-dark">–ë—É–∫–∏–Ω–∏—Å—Ç–∏–∫–∞</span>
        <span class="text-2xl font-black tracking-[0.05em]">DOMBB</span>
      </a>
      <a
        href="{% url 'main:catalog_all' %}"
        class="hidden items-center gap-3 rounded-xl bg-accent px-4 py-3 text-sm font-semibold text-ink transition hover:bg-accent-dark hover:text-graphite md:flex md:px-6"
      >
        <span class="flex h-4 w-4 items-center justify-center rounded-xl text-ink">
          <i data-lucide="book-open" class="h-5 w-5"></i>
        </span>
        <span>–ö–∞—Ç–∞–ª–æ–≥</span>
      </a>
      <form action="{% url 'main:catalog_all' %}" method="get" class="relative hidden flex-1 items-center rounded-2xl bg-white md:flex">
        <input type="hidden" name="sort" value="{{ current_sort|default:'popular' }}">
        <input
          type="text"
          name="q"
          value="{{ search_query }}"
          placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–Ω–∏–≥–∞–º"
          class="input h-12 w-full rounded-xl px-6 text-sm text-ink placeholder:text-ink-muted/70 focus:outline-none"
        >
        <button
          type="submit"
          class="absolute top-1/2 -translate-y-1/2 right-2 flex h-7 w-7 items-center justify-center rounded-xl bg-accent text-ink transition hover:bg-accent-dark md:h-8 md:w-8"
          aria-label="–ù–∞–π—Ç–∏"
        >
          <i data-lucide="search" class="h-4 w-4"></i>
        </button>
      </form>
      <div class="ml-auto hidden items-stretch gap-6 md:flex" >
        <a href="/favorites/" class="flex flex-col items-center gap-1 text-xs font-medium text-ink-muted transition hover:text-ink">
          <span class="flex h-10 w-10 items-center justify-center rounded-full border border-accent-soft text-ink">
            <i data-lucide="bookmark" class="h-5 w-5"></i>
          </span>
          –ó–∞–∫–ª–∞–¥–∫–∏
        </a>
        <div onclick="openCart()" class="flex flex-col items-center gap-1 text-xs font-medium text-ink-muted transition hover:text-ink cursor-pointer">
          <span class="flex h-10 w-10 items-center justify-center rounded-full border border-accent-soft text-ink">
            <i data-lucide="shopping-bag" class="h-5 w-5"></i>
          </span>
          <span id="desktopCart">–ö–æ—Ä–∑–∏–Ω–∞</span>
        </div>
        {% if request.user.is_authenticated %}
          <a href="{% url 'users:profile' %}" class="flex flex-col items-center gap-1 text-xs font-medium text-ink-muted transition hover:text-ink">
            <span class="flex h-10 w-10 items-center justify-center rounded-full border border-accent-soft text-ink">
              <i data-lucide="user-round" class="h-5 w-5 text-ink"></i>
            </span>
            –ü—Ä–æ—Ñ–∏–ª—å
          </a>
        {% else %}
          <a href="{% url 'users:login' %}" class="flex flex-col items-center gap-1 text-xs font-medium text-ink-muted transition hover:text-ink">
            <span class="flex h-10 w-10 items-center justify-center rounded-full border border-accent-soft text-ink">
              <i data-lucide="user-round" class="h-5 w-5 text-ink"></i>
            </span>
            –í–æ–π—Ç–∏
          </a>
        {% endif %}
        {% comment %} <a href="{% url 'main:catalog_all' %}" class="flex flex-col items-center gap-1 text-xs font-medium text-ink-muted transition hover:text-ink">
          <span class="flex h-10 w-10 items-center justify-center rounded-full border border-accent-soft text-ink">
            <i data-lucide="package" class="h-5 w-5"></i>
          </span>
          –ó–∞–∫–∞–∑—ã
        </a> {% endcomment %}
      </div>
    </div>
  </div>

  {% comment %} {% if categories %}
    <div class="mx-auto mt-4 flex w-full my-container gap-3 overflow-x-auto px-4 sm:px-6 lg:px-8 pb-1">
      {% for category in categories %}
        <a
          href="{% url 'main:catalog' category.slug %}"
          class="whitespace-nowrap rounded-full border border-accent-soft px-4 py-2 text-xs font-medium uppercase tracking-[0.2em] text-ink-muted transition hover:border-accent hover:bg-accent-soft/60 hover:text-ink {% if current_category == category.slug %}border-accent bg-accent/90 text-graphite{% endif %}"
        >
          {{ category.name }}
        </a>
      {% endfor %}
    </div>
  {% endif %} {% endcomment %}

  <div
    x-cloak
    x-show="mobileSearchOpen"
    x-transition.opacity.duration.200ms
    x-on:keydown.escape.window="mobileSearchOpen = false"
    x-on:click.self="mobileSearchOpen = false"
    class="fixed inset-0 z-50 flex flex-col bg-white px-5 py-6 backdrop-blur-md md:hidden"
    x-effect="mobileSearchOpen && $nextTick(() => $refs.mobileSearchInput && $refs.mobileSearchInput.focus())"
  >
    <div class="flex items-center justify-between gap-3">
      <div class="flex items-center gap-2 text-sm font-semibold text-ink">
        <i data-lucide="search" class="h-5 w-5 text-accent"></i>
        <span>–ü–æ–∏—Å–∫</span>
      </div>
      <button
        type="button"
        class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-accent-soft text-ink transition hover:border-accent hover:text-accent"
        x-on:click="mobileSearchOpen = false"
        aria-label="–ó–∞–∫—Ä—ã—Ç—å –ø–æ–∏—Å–∫"
      >
        <i data-lucide="x" class="h-5 w-5"></i>
      </button>
    </div>

    <form
      x-on:submit.prevent
      hx-get="{% url 'main:product_search' %}"
      hx-target="#mobile-search-results"
      hx-trigger="submit, input changed delay:350ms"
      hx-swap="innerHTML"
      class="mt-6 flex items-center gap-3 rounded-2xl border border-accent-soft bg-white px-4 py-3 shadow-sm"
    >
      <i data-lucide="search" class="h-5 w-5 text-accent"></i>
      <input
        type="search"
        name="q"
        placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏ –∏–ª–∏ –∞–≤—Ç–æ—Ä–∞"
        class="w-full border-none bg-transparent text-sm text-ink placeholder:text-ink-muted/70 focus:outline-none"
        autocomplete="off"
        x-ref="mobileSearchInput"
      >
    </form>

    <div id="mobile-search-results" class="mt-6 flex-1 overflow-y-auto pb-6">
      {% include 'main/search_results.html' with products=None search_query='' %}
    </div>
  </div>

  <div
    x-cloak
    x-show="mobileOpen"
    x-transition.opacity.duration.200ms
    x-on:keydown.escape.window="mobileOpen = false"
    x-on:click.self="mobileOpen = false"
    class="fixed inset-0 z-40 flex min-h-screen flex-col bg-white/95 px-6 py-8 backdrop-blur-md md:hidden"
  >
    <div class="flex items-center justify-between border-b border-accent-soft pb-4">
      <a href="{% url 'main:index' %}" class="text-lg font-semibold uppercase tracking-[0.35em] text-ink" >Dombb</a>
      <button
        type="button"
        class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-accent-soft text-ink transition hover:border-accent hover:text-accent"
        x-on:click="mobileOpen = false"
        aria-label="–ó–∞–∫—Ä—ã—Ç—å –º–µ–Ω—é"
      >
        <i data-lucide="x" class="h-5 w-5"></i>
      </button>
    </div>

    <nav class="mt-8 flex flex-col gap-4 text-base font-medium text-ink" x-on:click="mobileOpen = false">
      <a href="{% url 'main:index' %}" class="flex items-center justify-between rounded-2xl border border-accent-soft px-4 py-3 transition hover:bg-accent-soft/50">
        <span>–ì–ª–∞–≤–Ω–∞—è</span>
        <i data-lucide="arrow-right" class="h-4 w-4"></i>
      </a>
      <a href="{% url 'main:catalog_all' %}" class="flex items-center justify-between rounded-2xl border border-accent-soft px-4 py-3 transition hover:bg-accent-soft/50">
        <span>–ó–∞–∫—É–ø–∫–∞ –∫–Ω–∏–≥</span>
        <i data-lucide="arrow-right" class="h-4 w-4"></i>
      </a>
      <a href="#about" class="flex items-center justify-between rounded-2xl border border-accent-soft px-4 py-3 transition hover:bg-accent-soft/50">
        <span>–û –º–∞–≥–∞–∑–∏–Ω–µ</span>
        <i data-lucide="arrow-right" class="h-4 w-4"></i>
      </a>
      <a href="#contacts" class="flex items-center justify-between rounded-2xl border border-accent-soft px-4 py-3 transition hover:bg-accent-soft/50">
        <span>–°–≤—è–∑–∞—Ç—å—Å—è</span>
        <i data-lucide="arrow-right" class="h-4 w-4"></i>
      </a>
    </nav>

    <button
      type="button"
      class="mt-6 flex items-center justify-between rounded-2xl border border-accent px-4 py-3 text-base font-semibold text-ink transition hover:bg-accent-soft/60"
      x-on:click="mobileOpen = false; openCart();"
    >
      <span id="mobileCartHeader">–ö–æ—Ä–∑–∏–Ω–∞</span>
      <span class="inline-flex h-7 w-7 items-center justify-center rounded-full bg-accent text-ink">
        <i data-lucide="shopping-bag" class="h-4 w-4"></i>
      </span>
    </button>

    <div class="mt-10 grid grid-cols-2 gap-4 text-md text-ink-muted">
      <div class="space-y-1">
        <span class="text-xs uppercase tracking-[0.4em] text-accent">–ö–æ–Ω—Ç–∞–∫—Ç—ã</span>
        <p>üìû +7 (999) 123-45-67</p>
        <p>‚úâÔ∏è hello@libra-antiqua.ru</p>
      </div>
      <div class="space-y-1">
        <span class="text-xs uppercase tracking-[0.4em] text-accent">–ì—Ä–∞—Ñ–∏–∫</span>
        <p>üï∞ –ø–Ω‚Äë—Å–± 11:00 ‚Äì 19:00</p>
        <p>üìç –†–æ—Å—Å–∏—è, –ú–æ—Å–∫–≤–∞</p>
      </div>
    </div>
  </div>
</header>

<script>

// Cart functionality
const desktopCart = document.getElementById('desktopCart');
const mobileCart = document.getElementById('mobileCart');
const mobileCartHeader = document.getElementById('mobileCartHeader');

// Get initial cart count
updateCartCount();

function formatCartLabel(count) {
    return count > 0 ? `–ö–æ—Ä–∑–∏–Ω–∞ (${count})` : '–ö–æ—Ä–∑–∏–Ω–∞';
}

function updateHeaderCartCount(count) {
    const numericCount = typeof count === 'number' ? count : parseInt(count || 0, 10) || 0;
    const cartText = formatCartLabel(numericCount);
    if (desktopCart) desktopCart.textContent = cartText;
    if (mobileCart) mobileCart.textContent = cartText;
    if (mobileCartHeader) mobileCartHeader.textContent = cartText;
}

function updateCartCount() {
    fetch('{% url "cart:cart_count" %}')
        .then(response => response.json())
        .then(data => {
            updateHeaderCartCount(data.total_items);
        })
        .catch(error => {
            console.error('Failed to fetch cart count', error);
        });
}

function openCart() {
    htmx.ajax('GET', '{% url "cart:cart_modal" %}', {
        target: '#cart-container',
        swap: 'innerHTML'
    });
}

function initStickyHeader() {
    if (window.__stickyHeaderBound) return;
    window.__stickyHeaderBound = true;
    const header = document.querySelector('[data-sticky-header]');
    if (!header) return;
    const topRow = header.querySelector('[data-header-top]');
    const container = header.querySelector('.my-container');

    const apply = () => {
        const isSticky = window.scrollY > 10;
        header.classList.toggle('is-sticky', isSticky);
        if (container) {
            container.classList.toggle('shadow-md', isSticky);
            container.classList.toggle('ring-accent-soft/90', isSticky);
        }
        if (topRow) {
            topRow.classList.toggle('hidden', isSticky);
        }
    };

    apply();
    window.addEventListener('scroll', apply, { passive: true });
}

document.addEventListener('DOMContentLoaded', initStickyHeader);
</script>
