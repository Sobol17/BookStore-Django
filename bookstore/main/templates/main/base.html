{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>
    Dombb —
    {% if object %}
      {{ object.name }}
    {% elif is_catalog_page %}
      Каталог редких книг
    {% else %}
      Атмосфера букинистики
    {% endif %}
  </title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Playfair+Display:wght@400;500;600;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css">
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            paper: '#f1f1f1',
            ink: '#1F2532',
            'ink-muted': '#6F7588',
            accent: '#8BE3F5',
            'accent-dark': '#6FCBE0',
            'accent-darker': '#47A9C3',
            'accent-soft': '#E6F8FC',
            coffee: '#101829',
            blush: '#F26D9F',
            mint: '#C6F68D',
            graphite: '#2A3548'
          },
          fontFamily: {
            sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'],
            serif: ['Playfair Display', 'ui-serif', 'Georgia', 'serif']
          },
          boxShadow: {
            lamplight: '0 25px 50px -12px rgba(34, 49, 84, 0.22)',
            header: '0 18px 45px rgba(26, 37, 64, 0.08)',
            card: '0 22px 35px -18px rgba(29, 38, 59, 0.2)'
          }
        }
      }
    }
  </script>
  <style>
    [x-cloak] {
      display: none !important;
    }
    body {
      background-color: #F1F4FA;
      color: #1F2532;
      background-image: none;
    }
    .my-container {
      max-width: 1440px;
    }
    .input {
      background-color: #5d889614;
    }
  </style>
  {% block head_extra %}{% endblock %}
</head>
<body class="min-h-screen font-sans text-ink antialiased">
  <div class="min-h-screen bg-paper">
    {% include 'main/partials/_header.html' %}

    <main id="page" class="mx-auto flex w-full my-container flex-1 flex-col px-4 py-14 sm:px-6 lg:px-8">
      <div class="h-[3px] w-24 rounded-full bg-accent/70"></div>

      <section class="mt-12 flex-1" hx-target="this" hx-swap="innerHTML">
        {% if object %}
          <div data-name="product_detail" class="grid gap-10 lg:grid-cols-[minmax(0,1fr)_minmax(0,1.2fr)]">
            <div class="relative rounded-3xl border border-accent-soft/60 bg-white p-6">
              <div class="aspect-[3/4] overflow-hidden rounded-2xl border border-accent/20 bg-accent-soft/40">
                {% if object.main_image %}
                  <img
                    src="{{ object.main_image.url }}"
                    alt="Обложка: {{ object.name }}"
                    class="h-full w-full object-cover object-center transition duration-300 hover:scale-105"
                  >
                {% else %}
                  <div class="flex h-full w-full items-center justify-center bg-accent-soft text-ink">
                    Нет изображения
                  </div>
                {% endif %}
              </div>
              <div class="mt-6 space-y-3 text-sm text-ink-muted">
                {% if object.condition %}
                  <p><span class="font-semibold text-ink">Состояние:</span> {{ object.get_condition_display }}</p>
                {% endif %}
                {% if object.isbn %}
                  <p><span class="font-semibold text-ink">ISBN:</span> {{ object.isbn }}</p>
                {% endif %}
                {% if object.year %}
                  <p><span class="font-semibold text-ink">Год издания:</span> {{ object.year }}</p>
                {% endif %}
                {% if object.publisher %}
                  <p><span class="font-semibold text-ink">Издательство:</span> {{ object.publisher }}</p>
                {% endif %}
                {% if object.stock_qty %}
                  <p><span class="font-semibold text-ink">В наличии:</span> {{ object.stock_qty }} шт.</p>
                {% endif %}
              </div>
            </div>

            <div class="flex flex-col gap-8 rounded-3xl border border-accent-soft/60 bg-white p-8">
              <div>
                <p class="text-xs uppercase tracking-[0.4em] text-accent">
                  {% if object.category %}{{ object.category.name }}{% else %}Редкое издание{% endif %}
                </p>
                <h1 class="mt-3 font-serif text-4xl tracking-wide text-ink">
                  {{ object.name }}
                </h1>
                {% if object.authors %}
                  <p class="mt-2 text-base text-ink-muted">
                    {{ object.authors }}
                  </p>
                {% endif %}
              </div>
              <div class="flex flex-wrap items-center gap-6">
                <div>
                  <p class="text-sm uppercase tracking-[0.3em] text-ink-muted">Стоимость экземпляра</p>
                  <p class="mt-2 font-serif text-3xl text-accent">
                    {{ object.price }} {{ object.currency }}
                  </p>
                  {% if object.old_price %}
                    <p class="text-sm text-ink-muted">
                      <span class="line-through">{{ object.old_price }} {{ object.currency }}</span>
                    </p>
                  {% endif %}
                </div>
                <button
                  type="button"
                  class="rounded-2xl border border-accent-soft bg-accent px-6 py-3 text-sm font-semibold tracking-[0.2em] text-ink transition hover:bg-accent-soft/80 hover:text-graphite"
                >
                  Запросить экземпляр
                </button>
              </div>
              {% if object.description %}
                <article class="prose prose-sm prose-headings:font-serif prose-headings:text-ink prose-p:text-ink-muted prose-strong:text-ink max-w-none">
                  {{ object.description|linebreaks }}
                </article>
              {% endif %}
            </div>
          </div>

        {% elif is_catalog_page %}
          <div data-name="catalog_page" class="flex flex-col gap-12">
            <header class="flex flex-col gap-4">
              <p class="text-md text-accent">
                {% if current_category %}
                  Категория: {{ current_category_label }}
                {% else %}
                  Коллекция Libra Antiqua
                {% endif %}
              </p>
              <h1 class="font-serif text-4xl text-ink">Каталог редких книг</h1>
              <p class="max-w-2xl text-base text-ink-muted">
                Подборка букинистических изданий с сохранённой историей. Используйте фильтры, чтобы найти идеальный экземпляр для вашей коллекции.
              </p>
            </header>

            <div class="grid gap-12 lg:grid-cols-[minmax(0,290px)_1fr]">
              <aside class="space-y-6 rounded-3xl border border-accent-soft/60 bg-white p-6">
                <h2 class="font-serif text-xl text-ink">Подбор по параметрам</h2>
                <form action="." method="get" class="space-y-4">
                  <div>
                    <label for="q" class="text-xs uppercase tracking-[0.3em] text-ink-muted">Поиск</label>
                    <input
                      id="q"
                      name="q"
                      type="text"
                      value="{{ filter_params.q|default:search_query }}"
                      placeholder="Автор, название или издательство"
                      class="mt-2 w-full rounded-xl border border-accent/30 bg-white px-4 py-2 text-sm text-ink placeholder:text-ink-muted/70 focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/30"
                    >
                  </div>
                  <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-1">
                    <div>
                      <label for="min_price" class="text-xs uppercase tracking-[0.3em] text-ink-muted">Цена от</label>
                      <input
                        id="min_price"
                        name="min_price"
                        type="number"
                        value="{{ filter_params.min_price }}"
                        min="0"
                        class="mt-2 w-full rounded-xl border border-accent/30 bg-white px-4 py-2 text-sm text-ink placeholder:text-ink-muted/70 focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/30"
                      >
                    </div>
                    <div>
                      <label for="max_price" class="text-xs uppercase tracking-[0.3em] text-ink-muted">Цена до</label>
                      <input
                        id="max_price"
                        name="max_price"
                        type="number"
                        value="{{ filter_params.max_price }}"
                        min="0"
                        class="mt-2 w-full rounded-xl border border-accent/30 bg-white px-4 py-2 text-sm text-ink placeholder:text-ink-muted/70 focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/30"
                      >
                    </div>
                    <div>
                      <label for="year" class="text-xs uppercase tracking-[0.3em] text-ink-muted">Год издания</label>
                      <input
                        id="year"
                        name="year"
                        type="number"
                        value="{{ filter_params.year }}"
                        class="mt-2 w-full rounded-xl border border-accent/30 bg-white px-4 py-2 text-sm text-ink placeholder:text-ink-muted/70 focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/30"
                      >
                    </div>
                    <div>
                      <label for="author" class="text-xs uppercase tracking-[0.3em] text-ink-muted">Автор</label>
                      <input
                        id="author"
                        name="author"
                        type="text"
                        value="{{ filter_params.author }}"
                        class="mt-2 w-full rounded-xl border border-accent/30 bg-white px-4 py-2 text-sm text-ink placeholder:text-ink-muted/70 focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/30"
                      >
                    </div>
                  </div>
                  <div class="flex flex-wrap gap-3">
                    <button
                      type="submit"
                      class="rounded-2xl border border-accent-soft bg-accent px-5 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-ink transition hover:bg-accent-soft/80 hover:text-graphite"
                    >
                      Применить
                    </button>
                    <a
                      href="{% url 'main:catalog_all' %}"
                      class="rounded-lg border border-accent-soft px-5 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-accent transition hover:bg-accent-soft/20"
                    >
                      Сбросить
                    </a>
                  </div>
                </form>
                {% if genres %}
                  <div>
                    <h3 class="font-serif text-lg text-ink">Жанры и коллекции</h3>
                    <ul class="mt-4 space-y-2 text-sm text-ink-muted">
                      {% for genre in genres %}
                        <li class="rounded-lg border border-transparent px-3 py-2 transition hover:border-accent hover:text-ink">
                          {{ genre.name }}
                        </li>
                      {% endfor %}
                    </ul>
                  </div>
                {% endif %}
              </aside>

              <div class="space-y-8">
                {% if search_query %}
                  <p class="text-sm text-ink-muted">
                    Найдено по запросу
                    <span class="font-semibold text-accent">«{{ search_query }}»</span>
                  </p>
                {% endif %}
                <div class="grid gap-6 sm:grid-cols-2 xl:grid-cols-3">
                  {% for product in products %}
                    {% include 'main/partials/_product-card.html' with product=product %}
                  {% empty %}
                    <div class="col-span-full rounded-3xl border border-accent-soft/60 bg-white p-12 text-center text-ink-muted">
                      К сожалению, по выбранным параметрам ничего не найдено. Попробуйте изменить условия поиска.
                    </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        {% else %}
          <div data-name="home_page" class="space-y-16">
            {% include 'main/partials/_banner.html' with banners=banners %}

            <section class="relative overflow-hidden rounded-3xl border border-accent-soft/50 bg-white p-10  lg:p-16">
              <div class="absolute inset-0"></div>
              <div class="relative grid gap-10 lg:grid-cols-[minmax(0,1.1fr)_minmax(0,0.9fr)]">
                <div class="space-y-6">
                  <p class="text-xs text-accent-darker">
                    Букинистический салон старинных книг и атрибутики
                  </p>
                  <h1 class="font-serif text-4xl leading-tight text-ink sm:text-5xl">
                    Атмосфера старой библиотеки <span class="text-accent-darker">в вашем экране</span>
                  </h1>
                  <p class="text-lg text-ink-muted">
                    Libra Antiqua — коллекция отобранных изданий, сохранивших тепло страниц и историю владельцев. Мы подбираем редкие книги, которые хочется держать в руках.
                  </p>
                  <div class="flex flex-wrap gap-4">
                    <a
                      href="{% url 'main:catalog_all' %}"
                      class="rounded-xl border border-accent-soft bg-accent px-6 py-3 text-sm font-semibold text-ink transition hover:bg-accent-soft/80 hover:text-graphite"
                    >
                      Перейти в каталог
                    </a>
                    <a
                      href="#about"
                      class="rounded-xl border border-accent-darker px-6 py-3 text-sm font-semibold text-accent-darker transition hover:border-ink hover:bg-accent-soft/20 hover:text-ink"
                    >
                      О коллекции
                    </a>
                  </div>
                </div>
                <div class="relative">
                  <div class="absolute inset-0 translate-x-6 translate-y-6 rounded-3xl border border-accent-soft/70"></div>
                  <img
                    src="{% static 'images/demo-cover-1.jpg' %}"
                    alt="Интерьер букинистического магазина"
                    class="relative h-full w-full rounded-3xl object-cover"
                  >
                </div>
              </div>
            </section>

            {% include 'main/partials/_product-slider.html' with products=new_products title="Новинки" link=new_products_link %}

            {% if categories %}
              <section>
                <div class="flex items-center gap-6">
                  <div class="h-px flex-1 bg-gradient-to-r from-transparent via-accent-soft to-transparent"></div>
                  <h2 class="font-serif text-2xl text-ink">Коллекции и жанры</h2>
                  <div class="h-px flex-1 bg-gradient-to-r from-transparent via-accent-soft to-transparent"></div>
                </div>
                <p class="mt-4 max-w-2xl text-base text-ink-muted">
                  Наш каталог организован по тематическим коллекциям, чтобы вы быстро нашли произведения нужной эпохи или направления.
                </p>
                <div class="mt-8 grid gap-6 sm:grid-cols-2 xl:grid-cols-3">
                  {% for category in categories %}
                    <a
                      href="{% url 'main:catalog' category.slug %}"
                      class="relative flex flex-col gap-4 overflow-hidden rounded-3xl border border-accent-soft/60 bg-white p-8 transition hover:-translate-y-1"
                    >
                      <span class="text-xs uppercase tracking-[0.4em] text-accent">Коллекция</span>
                      <h3 class="font-serif text-2xl text-ink">{{ category.name }}</h3>
                      <p class="text-sm text-ink-muted">
                        {% if category.meta_description %}
                          {{ category.meta_description }}
                        {% else %}
                          Подборка изданий, созданных для ценителей редких книг и уникальных находок.
                        {% endif %}
                      </p>
                      <span class="mt-auto text-xs uppercase tracking-[0.4em] text-accent">
                        Смотреть книги →
                      </span>
                      <div class="absolute inset-0 rounded-3xl border border-transparent transition group-hover:border-accent"></div>
                    </a>
                  {% endfor %}
                </div>
              </section>
            {% endif %}

            {% include 'main/partials/_product-slider.html' with products=new_products title="Рекомендуемые находки" link=new_products_link %}

            <section id="about" class="grid gap-10 rounded-3xl border border-accent-soft/60 bg-white p-10 lg:grid-cols-2">
              <div class="space-y-4">
                <h2 class="font-serif text-3xl text-ink">Традиции букинистики и современные технологии</h2>
                <p class="text-base text-ink-muted">
                  Мы бережно описываем каждое издание, фиксируем состояние переплётов и листов, подбираем обложки с характером и историей. Коллекция регулярно пополняется благодаря партнёрам и частным библиотекам.
                </p>
                <ul class="space-y-3 text-sm text-ink">
                  <li class="flex items-start gap-3">
                    <span class="mt-1 h-2 w-2 rounded-full bg-accent"></span>
                    Гарантируем подлинность происхождения и описанного состояния каждого экземпляра.
                  </li>
                  <li class="flex items-start gap-3">
                    <span class="mt-1 h-2 w-2 rounded-full bg-accent"></span>
                    Помогаем подобрать книги под интерьер, коллекцию или конкретного адресата.
                  </li>
                  <li class="flex items-start gap-3">
                    <span class="mt-1 h-2 w-2 rounded-full bg-accent"></span>
                    Используем HTMX для мгновенного обновления каталога без перезагрузки страницы.
                  </li>
                </ul>
              </div>
              <div class="space-y-6 rounded-3xl border border-accent-soft/60 bg-white p-8">
                <h3 class="font-serif text-xl text-ink">Экспресс-консультация</h3>
                <p class="text-sm text-ink-muted">
                  Не нашли нужную книгу? Оставьте запрос — мы проверим архивные фонды и партнёрские каталоги.
                </p>
                <form class="space-y-4">
                  <div>
                    <label for="request-name" class="text-xs uppercase tracking-[0.3em] text-ink-muted">Имя</label>
                    <input
                      id="request-name"
                      type="text"
                      placeholder="Например, Анна"
                      class="mt-2 w-full rounded-xl border border-accent/30 bg-white px-4 py-2 text-sm text-ink placeholder:text-ink-muted/70 focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/30"
                    >
                  </div>
                  <div>
                    <label for="request-book" class="text-xs uppercase tracking-[0.3em] text-ink-muted">Запрос</label>
                    <textarea
                      id="request-book"
                      rows="3"
                      placeholder="Автор, название или описание нужной книги"
                      class="mt-2 w-full rounded-xl border border-accent/30 bg-white px-4 py-2 text-sm text-ink placeholder:text-ink-muted/70 focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/30"
                    ></textarea>
                  </div>
                  <button
                    type="submit"
                    class="w-full rounded-2xl border border-accent-soft bg-accent px-5 py-3 text-xs font-semibold uppercase tracking-[0.3em] text-ink transition hover:bg-accent-soft/80 hover:text-graphite"
                  >
                    Отправить запрос
                  </button>
                </form>
              </div>
            </section>
          </div>
        {% endif %}
      </section>
    </main>

    <section id="modal-root" class="mx-auto w-full my-container px-4 sm:px-6 lg:px-8" hx-target="this" hx-swap="innerHTML"></section>

    {% include 'main/partials/_footer.html' %}
  </div>

  <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.7/dist/htmx.min.js" integrity="sha384-ZBXiYtYQ6hJ2Y0ZNoYuI+Nq5MqWBr+chMrS/RkXpNzQCApHEhOt2aY8EJgqwHLkJ" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js" defer></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
	lucide.createIcons();
	
    document.body.addEventListener('htmx:configRequest', function (event) {
      const csrf = document.querySelector('input[name="csrfmiddlewaretoken"]');
      if (csrf) {
        event.detail.headers['X-CSRFToken'] = csrf.value;
      }
    });
    function initProductSliders() {
      if (!window.Swiper) {
        return;
      }
      document.querySelectorAll('.js-product-slider').forEach(function (container) {
        if (container.dataset.sliderInitialized === 'true') {
          return;
        }
        const root = container.closest('[data-slider-root]');
        const options = {
          slidesPerView: 1.1,
          spaceBetween: 16,
          breakpoints: {
            640: { slidesPerView: 2, spaceBetween: 20 },
            1024: { slidesPerView: 3, spaceBetween: 24 },
            1280: { slidesPerView: 5, spaceBetween: 28 }
          }
        };
        if (root) {
          const prev = root.querySelector('.js-slider-prev');
          const next = root.querySelector('.js-slider-next');
          if (prev && next) {
            options.navigation = {
              prevEl: prev,
              nextEl: next
            };
          }
        }
        new Swiper(container, options);
        container.dataset.sliderInitialized = 'true';
      });

      const bannerSwiper = new Swiper(container, {
          slidesPerView: 1,
          loop: true,
          autoplay: {
            delay: 5000,
            disableOnInteraction: false,
          },
          navigation: {
            nextEl: root.querySelector('.js-banner-next'),
            prevEl: root.querySelector('.js-banner-prev'),
          },
        });
    }

    document.addEventListener('DOMContentLoaded', initProductSliders);
    document.body.addEventListener('htmx:afterSwap', function (event) {
      if (event.detail.target && event.detail.target.closest('#page')) {
        initProductSliders();
        lucide.createIcons();
      }
    });
  </script>
  {% block body_scripts %}{% endblock %}
</body>
</html>
